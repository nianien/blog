1:"$Sreact.fragment"
2:I[10616,["6874","static/chunks/6874-7791217feaf05c17.js","7177","static/chunks/app/layout-142e67ac4336647c.js"],"default"]
3:I[87555,[],""]
4:I[31295,[],""]
6:I[59665,[],"OutletBoundary"]
9:I[74911,[],"AsyncMetadataOutlet"]
b:I[59665,[],"ViewportBoundary"]
d:I[59665,[],"MetadataBoundary"]
f:I[26614,[],""]
:HL["/_next/static/media/e4af272ccee01ff0-s.p.woff2","font",{"crossOrigin":"","type":"font/woff2"}]
:HL["/_next/static/css/232416e7c3a1ca7e.css","style"]
0:{"P":null,"b":"Ugi13mxW3xqx8EX5Ds9lw","p":"","c":["","blog","engineering","architecture","%E5%85%B3%E4%BA%8E%E4%B8%9A%E5%8A%A1%E5%B9%B3%E5%8F%B0%E6%9E%B6%E6%9E%84%E7%9A%84%E6%80%9D%E8%80%83",""],"i":false,"f":[[["",{"children":["blog",{"children":[["slug","engineering/architecture/%E5%85%B3%E4%BA%8E%E4%B8%9A%E5%8A%A1%E5%B9%B3%E5%8F%B0%E6%9E%B6%E6%9E%84%E7%9A%84%E6%80%9D%E8%80%83","c"],{"children":["__PAGE__",{}]}]}]},"$undefined","$undefined",true],["",["$","$1","c",{"children":[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/232416e7c3a1ca7e.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}]],["$","html",null,{"lang":"zh-CN","children":["$","body",null,{"className":"__className_f367f3","children":["$","div",null,{"className":"min-h-screen flex flex-col","children":[["$","$L2",null,{}],["$","main",null,{"className":"flex-1","children":["$","$L3",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L4",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":[[["$","title",null,{"children":"404: This page could not be found."}],["$","div",null,{"style":{"fontFamily":"system-ui,\"Segoe UI\",Roboto,Helvetica,Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\"","height":"100vh","textAlign":"center","display":"flex","flexDirection":"column","alignItems":"center","justifyContent":"center"},"children":["$","div",null,{"children":[["$","style",null,{"dangerouslySetInnerHTML":{"__html":"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}"}}],["$","h1",null,{"className":"next-error-h1","style":{"display":"inline-block","margin":"0 20px 0 0","padding":"0 23px 0 0","fontSize":24,"fontWeight":500,"verticalAlign":"top","lineHeight":"49px"},"children":404}],["$","div",null,{"style":{"display":"inline-block"},"children":["$","h2",null,{"style":{"fontSize":14,"fontWeight":400,"lineHeight":"49px","margin":0},"children":"This page could not be found."}]}]]}]}]],[]],"forbidden":"$undefined","unauthorized":"$undefined"}]}],["$","footer",null,{"className":"bg-[var(--background)]","children":["$","div",null,{"className":"mx-auto max-w-7xl px-6 py-12 lg:px-8","children":["$","p",null,{"className":"text-center text-xs leading-5 text-gray-400","children":["© ",2026," Skyfalling"]}]}]}]]}]}]}]]}],{"children":["blog",["$","$1","c",{"children":[null,["$","$L3",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L4",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]]}],{"children":[["slug","engineering/architecture/%E5%85%B3%E4%BA%8E%E4%B8%9A%E5%8A%A1%E5%B9%B3%E5%8F%B0%E6%9E%B6%E6%9E%84%E7%9A%84%E6%80%9D%E8%80%83","c"],["$","$1","c",{"children":[null,["$","$L3",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L4",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]]}],{"children":["__PAGE__",["$","$1","c",{"children":["$L5",null,["$","$L6",null,{"children":["$L7","$L8",["$","$L9",null,{"promise":"$@a"}]]}]]}],{},null,false]},null,false]},null,false]},null,false],["$","$1","h",{"children":[null,["$","$1","vtYulgAxebOb_yQFfaDq4v",{"children":[["$","$Lb",null,{"children":"$Lc"}],["$","meta",null,{"name":"next-size-adjust","content":""}]]}],["$","$Ld",null,{"children":"$Le"}]]}],false]],"m":"$undefined","G":["$f","$undefined"],"s":false,"S":true}
10:"$Sreact.suspense"
11:I[74911,[],"AsyncMetadata"]
13:I[6874,["6874","static/chunks/6874-7791217feaf05c17.js","968","static/chunks/968-d7155a2506e36f1d.js","6909","static/chunks/app/blog/%5B...slug%5D/page-3137b04d8f9ed325.js"],""]
14:I[32923,["6874","static/chunks/6874-7791217feaf05c17.js","968","static/chunks/968-d7155a2506e36f1d.js","6909","static/chunks/app/blog/%5B...slug%5D/page-3137b04d8f9ed325.js"],"default"]
16:I[40780,["6874","static/chunks/6874-7791217feaf05c17.js","968","static/chunks/968-d7155a2506e36f1d.js","6909","static/chunks/app/blog/%5B...slug%5D/page-3137b04d8f9ed325.js"],"default"]
1a:I[85300,["6874","static/chunks/6874-7791217feaf05c17.js","968","static/chunks/968-d7155a2506e36f1d.js","6909","static/chunks/app/blog/%5B...slug%5D/page-3137b04d8f9ed325.js"],"default"]
e:["$","div",null,{"hidden":true,"children":["$","$10",null,{"fallback":null,"children":["$","$L11",null,{"promise":"$@12"}]}]}]
15:T537c,<h3>从我们最熟悉的说起——业务是什么？</h3>
<ol>
<li>职业上的事务，统称为「业务」——辞海</li>
<li>“业务”更白话一些来说，就是各行业中需要处理的事务，但通常偏向指销售的事务，因为任何公司单位最终仍然是以销售产品、销售服务、销售技术等等为主。“业务”最终的目的是“售出产品，换取利润”。——百度</li>
<li>anything that relates to organizing the exchange of goods and services by a business, a governmental institution, or an agency”. ——OpenGroup Togaf—business architecture</li>
</ol>
<p><strong>业务的定义</strong></p>
<p>业务：企业接受客户订购，并将商品或服务交付给客户的一系列活动的总和，称之为一个业务。</p>
<p>业务的基本特征是产品+组织。当产品交付给客户时，面向不同客户、市场、行业，如何解决业务的差异性？答案是业务身份。</p>
<p>业务身份是现实业务在系统中给予的唯一编码标识，是基于“业务”差异性划分而形成的系统ID。业务身份的本质不是为了区分逻辑判断，而是区分需求来源以及规则的适用范围。因此，业务身份应该有全局的一致性。</p>
<p><strong>业务平台架构的定位是什么</strong></p>
<p>从业务内部看，要解决的主要问题是什么？</p>
<ul>
<li>创新：不断适应市场的业务策略</li>
<li>低成本：实施成本低</li>
<li>快速响应：能快速推进，快速试错</li>
<li>外部资源：易于获得生态内足够的外部资源，如流量、供给、渠道</li>
</ul>
<p>从全局看，怎样支持业务快速发展？</p>
<ul>
<li>基础强大：有强大的基础平台支撑，通用能力得到保证</li>
<li>组装灵活：可以快速选择部分能力，构建适合自身需要的支撑体系</li>
<li>易于变化：变化牵涉面小，可以快速定制</li>
<li>自主投入：不受基础平台资源瓶颈限制</li>
</ul>
<p>从内（技术）外（业务）两个角度看，需要的能力</p>
<ul>
<li>功能丰富：靠积累</li>
<li>易于复用：粒度合适，易于集成（技术兼容）</li>
<li>开放定制：平台开放（架构开放），运行解耦（部署灵活）、研发过程解耦</li>
<li>信息共享：概念一致、场景链接</li>
<li>沟通顺畅：共同的术语、对业务整体的一致认识</li>
</ul>
<p>从业务角度看，能够被复用或信息共享的前提</p>
<ul>
<li>核心管理对象的一致性</li>
<li>概念一致：对象+关系</li>
<li>数据描述一致：主数据</li>
<li>存在一定层次的流程一致性</li>
<li>关键活动</li>
<li>基本规则</li>
</ul>
<p>从从技术的角度，软件怎样被复用？</p>
<ul>
<li>功能复用：一段功能被完整使用</li>
<li>接口复用：输入输出定义复用，实现逻辑重写</li>
<li>流程复用：一段控制结构被复用，控制逻辑加上节点</li>
<li>规则复用：一段判断逻辑被复用</li>
</ul>
<p>复用的前提是业务实质的相似性，如果管理的核心对象存在较大差异，绝大部份情况下，以上复用都没可能。</p>
<p>业务平台的能力取决于</p>
<ul>
<li>是否存在基础的具有共性的关键业务环节</li>
<li>是否存在需要全局共享的关键资源</li>
<li>是否存在需要广泛连接的关键应用</li>
<li>是否存在需要大范围执行的管控规则</li>
<li>是否需要稳定性SLA</li>
</ul>
<p>其价值体现在于</p>
<ul>
<li>通过沉淀可复用的软件基础设施，达到降低成本的目的；</li>
<li>通过提供开放的基础架构能力，支持创新和差异化经营；</li>
<li>通过管理基础数据和基本流程节点，提供全局管控的手段和稳定性保障</li>
</ul>
<p><strong>业务架构模型分析</strong></p>
<ul>
<li>Business Process：TMF ，APQC</li>
<li>Business Capability：Open Group ;Gartner</li>
<li>Value Stream：Open Group</li>
<li>Business Service ：FEA</li>
</ul>
<p>描述业务的几个视角</p>
<ul>
<li>Business Capability (What)</li>
</ul>
<p>A particular ability or capacity that a business may process or exchange to achieve a specific purpose（业务为实现特定目的或结果而可能拥有或交互的特定能力或产能）</p>
<ul>
<li>Business Process (How)</li>
</ul>
<p>A set of structured activities or tasks with logical behaviors that produce a specific outcome, service or product（一组有逻辑行为的结构化活动或任务，产生特定的结果服务或产品）</p>
<ul>
<li>Business Value Stream(Why)</li>
</ul>
<p>A sequence of activities an enterprise undertakes to deliver on a customer request（表示一组端到端增值活动集合，这些活动为客户、干系人或者最终用户获得一个总体结果）</p>
<p>在推动企业IT服务能力的持续演进，业界已经有丰富的参考，分析前述参考模型可以看到：</p>
<ul>
<li>顶层的视图，不论哪种描述方式，都是先从企业的管理范围做大的划分——基于价值链的分析形成顶级视图，以是否直接服务客户为基准划分不同分类</li>
<li>从内容逻辑看，大多讨论都涉及组织、能力、过程的关系。</li>
<li>虽然在不同的时期，不同的视角，强调的重点不同，但都是希望建立更易于为业务理解的视图，并成为构建IT系统的桥梁。</li>
</ul>
<p>通常，企业架构包括业务架构、技术架构、应用架构、数据/信息架构，而业务平台最薄弱的环节在于业务架构：</p>
<ul>
<li>已经形成框架，但缺乏对关键概念的确切定义</li>
<li>已经形成平台，但缺乏长期演进的规划指引</li>
<li>已经形成对业务的基础性支撑，但基础能力没有明确的定义</li>
<li>平台团队，缺乏对业务的结构化思考框架指引，容易造成团队能力的瓶颈</li>
</ul>
<p>因此，我们首先需要健全业务架构体系。业务架构体系的构建关键在于先要建立业务视角。那么，什么是业务视角？</p>
<ul>
<li>用业务发生的方式描述业务：围绕能力、流程与场景描述</li>
<li>将业务现象背后的逻辑进行结构化呈现</li>
<li>强调结果而非方法实现，屏蔽技术细节</li>
</ul>
<p>那我们要如何才能建立业务视角呢？</p>
<ul>
<li>首先要明确业务目标，理解业务含义，知道结构划分的依据</li>
<li>要建立端到端的全流程视角，业务需求能够对应到系统功能</li>
<li>在业务沟通中，统一使用达成共识的业务语言而非技术术语</li>
<li>系统被业务感知的部分要有明确的业务语义以及清晰的边界</li>
</ul>
<p>业务平台架构是一个以流程为基础，以能力为表达的层次结构。第一层，明确语义和范围；第二层，构建完备、正交的业务模型；第三层，与交付形态相结合，提供服务SLA。无论从能力角度，还是从流程角度，都是对企业行为的一种描述方式。我们既可以通过满足的客户需求出发，构建能力的集合，也可以根据流程到企业能力的对应，建立起整体的能力框架或过程框架。</p>
<p><strong>关于域（domain）的思考：过程域、功能域、能力域、信息域</strong></p>
<p>域是一个广泛被使用的词，但是定义也很宽泛。（BD：特指某一专业性范围，涉及在该范围内的所有事项均可引用）领域建模这个词很熟悉，但具体领域是什么，在我们当前的实践中并没有可以判定的简单标准。域常常被理解为不同的场景：功能域、过程域、数据域。如果从OO的核心思想出发，则可以将域做一个统一认知：</p>
<ul>
<li>功能是对象行为的外部表现，但作为域的聚合的依据是对象</li>
<li>对象的行为和数据是不可分开的，过程是对象行为的执行过程</li>
</ul>
<p>基于以上的认知，域的概念可以统一为“信息域”，数据是信息的载体，信息是对数据的语义解释。因此，领域建模就是找出问题范围内的对象及其关系，根据对象间关系的紧密程度，来确定是否属于一个域。</p>
<p>价值链把企业的能力划分为核心能力以及辅助能力的划分，实质是以客户为中心，区分客户与企业两个角色。根据TMF-eTom的划分方式，在核心流程进一步细分基础设施和战略、运营，和生产不直接相关的活动都定义为企业管理。</p>
<p><strong>能力的语义分析——5W1H的逻辑</strong></p>
<ul>
<li>Why 强调价值</li>
<li>What 强调目标</li>
<li>When 时间</li>
<li>Where 地点</li>
<li>Who 参与人</li>
<li>How 方式方法</li>
</ul>
<p>当我们在较高层次谈能力，往往是在谈Why和What；在较低或细节的层次谈能力，则往往强调的是3W1H——即做的程度和特性。</p>
<p>能力的描述通常有两种形式：一是按照做什么和达到的目标来描述；二是按照特性来描述。而特性往往体现为两类：</p>
<p>一是对一个或多个对象属性值的组合的描述，值的组合往往体现为场景。比如担保交易是一个能力描述，那么担保本身是交易的分类特性，就是交易具有的特点。</p>
<p>二是对一个过程执行的非功能特点的描述。如时间、空间等。比如秒杀，描述的是交易的时间特性，又比如店铺红包，描述的是红包使用的范围（也可以理解为空间特性）。</p>
<p>能力的特性描述实际是场景切分的方式。一旦进入场景，就是离散的结构，而按照流程的能力划分方式，则可以是逐步细化的方式，会形成树状的结构。如果我们把二者结合，并加以规范，就能形成既可以满足MECE，又能够把两种特点有效体现的描述方式。</p>
<ol>
<li>按照端到端流程完成初始能力描述</li>
<li>找到流程的各个环节，分解成不同的能力</li>
<li>在流程各个环节里，找出关键参数，描述业务的适应能力</li>
<li>找出关键的非功能性的特性</li>
<li>把流程各个环节较为固定的组合找出来</li>
</ol>
<p><strong>能力分析 vs 流程分析</strong></p>
<p>能力：要达到一个目的，得到一个结果，如果是服务于客户，从客户的角度看，就是“我” 帮客户完成了一件什么事情</p>
<p>流程：我要干一件什么样的事情，其的步骤，体现的是做的过程。</p>
<p>从划分的结果来看，能力划分和流程划分是一致的，但从思考的角度看，是不同的。从划分的确定性看，因为角色有限，能力从结果和目标的角度，避开路径的复杂性，有更强的确定性。</p>
<p><strong>业务建模 vs 业务架构</strong></p>
<p>在独立讲述流程建模或者能力建模的论述中，都强调用业务的语言，构建符合业务习惯的成果。业务建模只强调逻辑的完整性，但是在以IT实现为目标的前提下，业务建模和IT实现之间必须建立简单的对应关系。无论是能力建模或者过程建模，最终要与信息模型建立映射关系。在业务分散而平台支撑要统一的情况下，也可以看作是IT在寻找和业务的共同语言。</p>
<p><strong>商业能力的划分</strong></p>
<p>能力划分的核心是围绕客户，以是否与客户诉求直接相关作为基准划分。在顶层的视图，划分能力和流程的视角是一致的。因为无论流程视角还是能力视角，都要找出我们能为客户做什么。所以，我们仍然可以区分三类能力：1）客户销售与服务能力；2）支撑能力；3）企业管理能力。</p>
<h4>能力划分的逻辑</h4>
<p>能力划分是自顶向下的逻辑分解的过程。能力分析的出发点首先是角色分析，以满足角色的诉求为目的，因此，其顶层的划分都是以角色的诉求为划分基础，本质是场景（或流程）的划分。前端的能力是直接服务于客户需求的，所以其顶层可以按消费的逻辑进行划分。场景的细分本身可以构成能力细分的逻辑基础，但仍然需要找到场景细分的逻辑。后端支撑能力本质是服务于经营者，可以从经营者的诉求进行划分。但因为内部角色的分散，难以在顶层形成贯穿全局的流程主线，就会形成面向资源的分散流程。所以，其能力划分既可以按大的角色分类进行，也可以直接按资源分类进行。这里的资源，本质就是我们所说的域。这也代表了一类细分的思路，在场景细分的划分基础上，通过资源的分类完成下一级的细分。即便到了资源的分类层次，仍有可能进一步细分的必要，这又会回到场景划分的逻辑。所以，业务能力建模的过程也是在不断寻找不同层次的能力切分逻辑的过程。</p>
<p>从全局看，核心是以客户为中心进行能力的划分，其实质是按照直接满足客户需求到为满足客户需求进行间接准备来划分。实际上，每一部分能力都服务于生态中的某个特定角色，所以在能力的描述上，直接满足的是当前角色的价值要求，间接地通过客户为中心视角进行原则性校验。</p>
<p><img src="/images/blog/engineering/business-image_4_1.png" alt="image_4_1.png"></p>
<ul>
<li>企业的能力围绕“客户、企业自身、合作伙伴” 的生态形成闭环。</li>
<li>前端围绕满足客户需求</li>
<li>后端分为满足生产要素管理和满足企业自身管理</li>
<li>企业管理暂不涉及</li>
</ul>
<p><img src="/images/blog/engineering/business-image_4_2.png" alt="image_4_2.png"></p>
<p><strong>后端支撑能力与企业管理能力</strong></p>
<ul>
<li>后端支撑能力<ul>
<li>客户管理</li>
<li>产品管理（PLM）</li>
<li>合作伙伴管理*</li>
<li>营销活动管理</li>
<li>账单与收入管理</li>
<li>资源管理</li>
</ul>
</li>
<li>企业管理能力<ul>
<li>人力资源</li>
<li>财务</li>
<li>技术发展</li>
<li>基础建设</li>
<li>法务</li>
<li>……</li>
</ul>
</li>
</ul>
<p><strong>从概念性的能力到软件实现的层次</strong></p>
<p><img src="/images/blog/engineering/business-image_4_3.png" alt="image_4_3.png"></p>
<p><strong>能力的表现形式</strong></p>
<ul>
<li>高层的能力，应该是逻辑的表达，对应于软件的整体或可独立交付的部分</li>
<li>低层的能力，应该和软件的外在存在形式关联，如分布式环境中的服务接口、SDK中定义的接口</li>
</ul>
<p><strong>能力的划分</strong></p>
<p>能力是围绕以完成客户诉求为目标来划分的，完成一个能力可能需要多个领域对象的协作。能力的细分有横向和纵向的划分方式，未必代表软件实现的粒度细分，所以要建立能力和软件实现的映射关系。但在能力粒度上，一定需要和软件的交付物有一致并且明确的边界。</p>
<p><strong>再看能力、流程、域的关系</strong></p>
<p>能力是按照完成目标来划分的，流程是按照执行过程划分的，域是按照实体聚合切分的。业务流程是业务感知结果的流程，系统流程是执行步骤的划分。域内可以有流程，域的多项能力可能对应细分流程的多个步骤，不一定有必然的先后顺序，也可能是离散的能力组合。域和能力之间也需要在一定的粒度上建立映射关系，否则会造成在域和能力都有很多层次，并在多个层次间建立复杂的映射。</p>
<p><strong>商业能力层和域内的关系</strong></p>
<p>商业能力是客户可直接感知的能力，越是面向客户直接交互的层次，在技术上越难以限制其差异性，可能会与需求直接映射；越是趋近技术实现的层次，越是需要更高的抽象，以间接满足需求。</p>
<p>商业能力提供流程性的封装，在顶层按照与客户的交互场景划分，并结合域的划分进行分解。商业能力层以提高交互场景的合理性和对外的灵活性为目标，关注的是面向客户体验的逻辑实现。各域内以实现领域内的接口复用为目的，提供合适粒度的接口，与商业能力层确认概念模型。</p>
<p>商业能力团队应该首先是一个设计团队，其次才是一个实现团队。设计应该是和各域一起探讨的过程，商业能力要限制向下层过度延伸，也要迫使下层要更注重域内抽象。在设计过程中，逻辑分解应该尽量形成在各域的独立逻辑，然后组合成对外的交互逻辑。最外层交互所依赖的服务都在商业能力层实现封装，应该以业务设计结果为准，而不是技术设计，对外的扩展点，都在商业能力层定义和体现。</p>
<p><strong>商业能力在软件结构上的分层</strong></p>
<p>如果对外提供的就是商业能力，那么域和商业能力的边界到底在哪里？</p>
<ul>
<li>所有在SDK、RPC接口中对外提供调用或者是SPI提供实现的，都在商业能力层定义。</li>
<li>也就是，需要提供给外部使用或扩展的，这里不包含界面层对后端的调用，界面是软件的一部分。</li>
</ul>
<p>这里就要区分什么是内，什么是外？</p>
<ul>
<li>这个和我们定义的商业能力的服务对象有关系，如果按照组织来分，那就要考虑组织的边界和能力的分层，比如，业务平台面对业务方，业务平台就是内。</li>
<li>如果考虑放大到所有提供中台能力的都和业务平台同等的地位，那么，整个中台就是内。但这样就要有整个中台的统一的对外组织和架构标准了。</li>
<li>如果从企业内外来看，客户就是外，企业就是内。</li>
</ul>
<h4>商业能力和域的分层及域间关系</h4>
<p>问题在于域间是否允许调用呢？如果允许，这样的域内调用和外部通过商业能力的调用差别是什么？对于依赖另一个域的实体对象信息的查询调用，都允许。对于依赖另一个域的判断的调用，或者嵌入另一个域的处理环节的调用，都禁止，交给上层去集成。也就是说，上层进行逻辑和控制结构的组装，不限制下层的信息查询，但限制下层的逻辑蔓延。</p>
<p>对于下层能够独立完成的判断逻辑，或者处理环节，鼓励下层去做。但对象必须有属主域，判断应该是本域的关键对象的行为判断，而不能是跨越边界。判断什么是查询，只有直接被认为是对象的直接属性的内容，被认为是查询，所以对于一个域要有基本的概念模型。</p>
<h4>商业能力的表达</h4>
<p>对组织边界外的外部系统服务，都是商业能力封装，对于和客户直接交互的提供给界面的都是商业能力。商业能力本身可以分成两类：一类是领域内服务，一类是跨域服务。跨域服务，可以作为独立的分类。从上下级关系看，上级的逻辑必然覆盖下层的逻辑，建立能力树，是给用户导航的方式。</p>
<p><strong>基于企业架构，构建业务架构</strong></p>
<p>要想构建业务平台架构，我们需要有一套行之有效的构建方法论。方法论的构成包括：原理过程+表示法+工具。</p>
<p>如下图所示，能力地图代表业务架构，概念模型代表信息架构。对于多数业务平台，一般技术架构都已经有较为明确的选择。所以，业务平台亟需构建的是除技术架构之外的泛“业务架构”。从企业管理维度上看，企业架构在业务平台通常可以解决的问题包括：</p>
<ul>
<li>研发投资的价值识别</li>
<li>架构演进的组织方法</li>
<li>组织的职责划分</li>
</ul>
<p><strong>构建架构体系</strong></p>
<p>战略-模式-能力-过程</p>
<p>业务架构的边界来源于战略输入。从能力的角度，产品目录是业务架构的延续；从实现的角度，产品目录是应用架构的延续。在交互层面，通过合适的集成手段，实现应用功能面向用户的有效整合。应用架构的边界和域的边界有内在的关联，可以通过自顶向下的讨论以及循环迭代完成演进。</p>
<p><strong>构建能力地图</strong></p>
<ul>
<li>确定架构定义及结构描述<ul>
<li>分层划分的规则确定</li>
</ul>
</li>
<li>现状描述<ul>
<li>能力地图的草稿初建</li>
</ul>
</li>
<li>搜集关键场景，确定目标架构<ul>
<li>补充关键演进场景</li>
</ul>
</li>
<li>Gap分析</li>
<li>演进计划</li>
<li>构建一个基础的完备正交集合</li>
<li>构建不同场景的视图<ul>
<li>外部客户交付关键能力视图</li>
<li>内部业务的热点关键能力视图</li>
</ul>
</li>
</ul>
<p><strong>构建概念模型</strong></p>
<ul>
<li>现状搜集<ul>
<li>已经被广泛引用的概念、实体</li>
<li>已经被广泛使用的术语</li>
<li>已经被相对固化的流程节点</li>
<li>已经广泛使用的场景</li>
</ul>
</li>
<li>未来场景搜集<ul>
<li>战略输入</li>
<li>业务规划</li>
</ul>
</li>
<li>建模<ul>
<li>域划分</li>
<li>模型定义</li>
<li>耦合验证</li>
</ul>
</li>
<li>演进计划</li>
</ul>
17:T508f,<p>　　账户体系是支付系统的基础，它的设计直接影响整个系统的特性。这里探讨如何针对电子商务系统的账户体系设计。我们从一些基本概念开始入手，了解怎么建模。</p>
<h3>1 三户模型 <a href="#t1" id="t1"></a></h3>
<p>　　三户模型最早是在增强型电信运营图（Enhanced Telecom Operations Map，eTOM）中提出，在电信行业中得到广泛使用。 三户指客户（Customer）、用户（User）和账户(Account)。eTOM 引入是电信行业营销模型转向“以客户为中心”的理念而产生的成果。围绕客户建立用户和账户，这三个是相互关联的实体。近年来，金融行业也逐步接受和采用了三户模型。</p>
<ul>
<li><strong>客户</strong>，指自然人或者法人。法人一般被称之为企业客户。如无特指，一般客户指个人客户。</li>
<li><strong>用户</strong>，指通过注册的方式进入系统，使用系统提供的服务的实体，也称为登录账户，即用户在系统中登录凭证和个人信息。对应的，法人客户在系统中注册后，被称之为商户。</li>
<li><strong>账户</strong>，这里特指支付账户，指用户在支付系统中用于交易的资金所有者权益的凭证。</li>
</ul>
<h3>2 客户 <a href="#t2" id="t2"></a></h3>
<h4>2.1 个人客户 <a href="#t3" id="t3"></a></h4>
<p>　　在银行体系中，一般是先有客户，再有用户。早期个人客户通过柜台人员操作注册到银行体系中，柜台人员在处理时，先添加客户信息，再注册账户信息。而在互联网系统中， 一般是用户先注册，先有用户，然后补充客户身份信息。也就是客户身份信息是在运行过程中逐步完善的。在银行柜台，操作人员通过面签或实名方式在系统中建立客户对象。这个对象的业务主键是证件号（如，身份证，假设目前 18 位证件都不重号），所有相同证件我们都视为同一个客户，不论是不是同一个系统中。同一个证件号，不论在工行还是中行，开出来的客户，其实都对应着现实中的同一个人。</p>
<p>　　在一个平台体系中，通过系统给客户分配的唯一 ID 号客户 ID 来标识客户对像。这里面就有一个关键业务，既然相同证件都会识别成一个客户，那么当相同的证件号进入系统时，系统是如何处理的？当然是合成一个了，这个过程叫做客户归并，即：<strong>将相同证件的客户合成同一个客户号的过程，我们称为归并</strong>。归并是有风险的，所以需要一些鉴权手段来处理。在互联网应用中，一个系统中客户的生命周期如下：</p>
<p><img src="/images/blog/engineering/business-image_3_1.png" alt="image_3_1.png"></p>
<p>注意在这个流程中没有销户的状态。这是为了支持历史业务的处理，客户一般不做销户。此外这个流程和支付账户的流程比较类似，这是为了方便在客户层面做账户控制。以司法协查为例，某个客户被协查以致账户冻结，需要冻结该客户下所有资金账户，这些账户都被止付。</p>
<h4>2.2 企业客户 <a href="#t4" id="t4"></a></h4>
<p>　　企业客户相对个人客户来说比较复杂点，但三户模型仍然适用。同个人客户一样，企业客户在银行或支付平台开设资金账户，资金账户归属于此客户。企业客户是一个组织，其账户必然是组织授权内部人员去操作。但是这个操作人，同个人客户一样，只是系统的使用者，即用户。企业的资金比较大，并且有严格的业务流程，所以在系统使用上，一般是多个用户操作一个或多个资金账户。这种关系本身来说，也是一种授权关系，企业授权相应的用户来操作特定的资金账户，只不过为了管理方便，可以引入角色管理机制来实现。对于支付公司来说，企业客户通常都是发展商户过程中产生的。企业客户的识别同个人客户识别也是一样的，通过企业证件来统一识别。相同的企业证件号归并到同一个企业客户下面。建立企业客户的好处在于：</p>
<ul>
<li>有些企业本身只开通了企业服务业务，而不开通商户服务；</li>
<li>一个企业可以开通多个商户，企业客户是这些多个商户的统计口径。</li>
</ul>
<h4>2.3 客户模型 <a href="#t5" id="t5"></a></h4>
<p>　　对客户的处理，在银行系统中是 CIF 系统或 ECIF 系统，而在互联网模式下，很多都是基于微服务的体系，如何划分微服务，这块要从客户系统对提供的业务主题来分。比如：对于个人客户，客户识别就是一个服务主题，对于一个客户有多种多样的识别方式，除了证件外，还包括生物识别，比如画像、指纹等。</p>
<ul>
<li>基本信息也是一个服务主题：包括客户的最基本的信息，姓名、年令、职业等;</li>
<li>管理信息也是一个服务主题：比如这个客户的评级、是否集团员工等；</li>
<li>客户标签也是一个服务主题：所谓标签，就是从不同的维度来给客户做个标记，一个客户有多个标签，当然，前提是要对标签做好规划；</li>
<li>协议管理也是客户的一个服务主题：这里面有授权协议、委托协议等。</li>
</ul>
<p>当然，客户还有其它的一些主题，这个要看公司的业务了。</p>
<p><img src="/images/blog/engineering/business-image_3_2.png" alt="image_3_2.png"></p>
<h3>3 用户和商户 <a href="#t6" id="t6"></a></h3>
<h4>3.1 用户 <a href="#t7" id="t7"></a></h4>
<p>　　用户是账户的操作实体，它是由客户来注册到系统中来的。虽然用户通过客户间接的拥有了资金账户，但这种关系并不是绝对的，比如，一个用户可以授权另一个用户进行账户的余额查询。所以，用户与资金账户之间我们可以抽象出一种授权关系，凡是授权用户，都可以操作资金账户，当然，这种授权包括客户自己的用户。用户的建立比较简单，一般自助注册后就可以生成用户实体了。用户的生命周期如下：</p>
<p><img src="/images/blog/engineering/business-image_3_3.png" alt="image_3_3.png"></p>
<p>　　如果用户通过简易注册方式生成，这种情况下生成的是个预开户状态的用户，用户需要进一步完善一些信息才能变成正常用户，比如有些平台，在用户第一次登录时要求设置密保问题及答案。如果用户采用标准注册方式注册 的，可以直接成正常状态用户，正常做业务了。</p>
<p>　　如果用户想要销户，收到销户申请后，不能直接销户，前面我们说过了，客户是通过用户来进行资金账户的管理与操作的，没有用户，资金账户就有可能没法玩了（假设客户只授权自己的一个而且只有一个用户来操作资金账户），特别是一些账户还存在债务。所以，此时有个确认过程，要求各业务系统确认此用户下的所有账户是否可以销户，如果没有问题，先销资金账户，当用户下的所有资金账户都销户完毕，再销用户，用户销户完成后，会释放出此用户占用的资源，如注册手机号。</p>
<p>　　用户除了生命周期状态外，还有一个管理状态，比如冻结，从现实模型中来说，这个是不应该放在用户层面的而是放在资金账户层面上的，但互联网模式下，一个用户有多个资金账户，为了用户体验，把这些放在了用户层面上了，就如同支付密码放在用户层面上一样。</p>
<h4>3.2 商户 <a href="#t8" id="t8"></a></h4>
<p>　　商户是企业客户的一个业务影子，或是看成资金账户分组的一个手段。商户是客户一个外围业务，如果把它看成用户平级层面也是可以的，即：此商户所有业务产生的资金进入到一个分类资金账户里。不论怎么说，一个企业不论开多少个商户，每个商户又开通多少个资金账户，都改变不了资金账户的归属关系，它是现实客户这个实体的。对客户的处理，在银行系统中是 CIF 系统或 ECIF 系统，而在互联网模式下，很多都是基于微服务的体系，如何划分微服务，这块要从客户系统对提供的业务主题来分。</p>
<h3>4 账户 <a href="#t9" id="t9"></a></h3>
<h4>4.1 基本概念 <a href="#t10" id="t10"></a></h4>
<p>　　账户设置，一般是从交易开始的。交易的实现必须有账户的支持，账户是交易的基本构成元素。从支付系统的角度，交易中涉及到的资金流是资金从一个账户流向另一个账户。发起交易的一方，被称之为交易主体，他可以是个人，也可以是一个机构。资金从该主体所拥有的账户中流出。而接收交易的一方，被称为交易对手，他也可以是个人，或者机构。和第三方支付或者金融机构的交易不同，电商系统中，交易还会涉及到渠道。由于电商系统本身并无清结算的资质，所有资金从交易主体到交易对手的账户的流动，在大部分情况下，并没有经过电商系统，而是由电商系统调用支付渠道提供的接口，由它来完成真正的支付过程。当然，渠道也不是活雷锋，在这个过程中，渠道要收取费用。所以，在电商系统中，一次交易会涉及到三个账户： 交易主体账户、交易对手账户以及支付渠道账户。</p>
<p><strong>支付账户和登录账户</strong></p>
<p>　　账户体系设计首先要区分两个概念，支付账户和登录账户。这是两个不同业务领域的概念。<strong>支付账户</strong>指用户在支付系统中用于交易的资金所有者权益的凭证。<strong>登录账号</strong>指用户在系统中的登录的凭证和个人信息。一个用户可以有多个登录账户，一个登录账户可以有多个支付账户，比如零钱账户，储值卡账户等。 一般来说，支付账户不会在多个登录账户之间共用。如果没有特殊说明，下文中的账户，都默认指支付账户。</p>
<p><strong>会计科目与账户</strong></p>
<p>　　公司的会计需要对每一笔交易都要做详细的记录，即记账。公司每天都产生大量的交易行为，为了便于管理和统计，一个简单的方法是对交易进行分类，比如食品、带宽、办公用品等等。这个分类，按照公司的规模和业务复杂度，可以有一级、二级、三级或者更多级的结构，这被称之为<strong>会计科目</strong>。记账时，除了交易明细，还需要在每个级别上对交易额进行汇总。 一般来说，一级科目上汇总称为<strong>总帐科目</strong>，而详细记录称为<strong>明细科目</strong>。在电商系统中，由于涉及到的参与方较多，记账也相对复杂，但基本方法也是类似的。电商的参与者可以分为商户、买家和渠道，对这三类参与者，都需要分别建立总帐账户和明细账户。</p>
<p><strong>内部账户和外部账户</strong></p>
<p>　　当用户使用银行卡来支付时，电商支付系统需要和银行对接，从用户银行卡所代表的账户上扣除资金。对接了银行，第三方支付等机构的电商支付系统，它需要连接到用户在这些机构的账户来执行扣款或者充值操作，这些账户称为<strong>外部账户</strong>。对外部账户，支付系统只能记录账户在本系统的明细以及累计消费额，无法得知账户真正余额。不少电商在玩零钱的概念，也就是让用户充值到零钱，使用的时候就直接从零钱中扣除。这就需要零钱账户。这是电商系统中自己设立的账户，所以也叫<strong>内部账户</strong>，可以知道账户的全部消费明细和余额。当然，除了零钱账户，也可以有储值卡账户、信用账户等。那问题来了，什么时候需要建立账户，比如优惠券，需要账户吗？一次消费的储值卡和可以充值的储值卡，需要建立账户吗？这里先埋个雷。</p>
<p><strong>收款账户和收单账户</strong></p>
<p>　　当电商要对接银行时，往往都会被要求开设一个收款账户。用户通过这个银行来支付时，钱就被转到这个账户上。对第三方支付也是一样。收款账户是开设在银行或者第三方支付这边的，即渠道侧。一般来说，渠道每天都可以提供这个账户的交易流水供电商对账用。这样在电商这边，渠道就成为一个收单机构。所以在电商这边，建立这个收款账户对应的对账用的收单账号，用来记录通过这个渠道进行的各项交易流水。</p>
<h4>4.2 三类账户 <a href="#t11" id="t11"></a></h4>
<p>　　在设计支付账户系统时，合规是第一要求，和账户相关的法规，最重要的是近期央行发布的三个文件。 从 2013 年 3 月起，国家相继制定一系列“互联网+”计划，推动了移动互联网、大数据等与现代制造业、服务业相结合，引导企业转型，促进经济健康发展。在此背景下，央行相继发布了三个文件：</p>
<ul>
<li>「<strong>中国人民银行关于改进个人银行账户服务加强账户管理的通知</strong>」，银发〔2015〕392 号，2015 年 12 月 25 日发文，正式启动账户分类管理工作。</li>
<li>「<strong>中国人民银行关于落实个人银行账户分类管理制度的通知</strong>」，银发〔2016〕302 号, 2016 年 11 月 25 日发文，明确了同一个人在同一个银行只能有一个<code>I</code>类账户的要求。</li>
<li>「<strong>中国人民银行关于加强支付结算管理防范电信网络新型违法犯罪有关事项的通知</strong>」，银发〔2016〕261 号， 2016 年 9 月 20 日发文，调整并细化了账户分类及使用要求。</li>
</ul>
<p>在这些文件中，央行明确对账户实施分类管理的要求。 对这三类账户区别，总结如下：</p>
<p><img src="/images/blog/engineering/business-image_3_4.png" alt="image_3_4.png"></p>
<h4>4.3 生命周期 <a href="#t12" id="t12"></a></h4>
<p><img src="/images/blog/engineering/business-image_3_5.png" alt="image_3_5.png"></p>
<ul>
<li><strong>账户开立与绑卡</strong>：同一个人在同一银行只能开立一个<code>Ⅰ</code>类户，<code>I</code>类户的设立需要面对面审核，电子渠道开立的<code>Ⅱ</code>类户和<code>Ⅲ</code>类户需绑定银行账户进行验证，不得绑定支付机构账户验证，<code>Ⅱ</code>类户需向绑定账户验证<code>5</code>要素（<code>4</code>要素：姓名、身份证号、手机号、银行卡号，额外增加账户等级），<code>Ⅲ</code>类户需验证<code>4</code>要素，银联支持支持<code>Ⅱ</code>、<code>Ⅲ</code>类账户跨行验证绑定账户信息。</li>
<li><strong>资金互转</strong>：对非面对面开立的<code>Ⅱ</code>、<code>Ⅲ</code>类户，限制非绑定账户转入，允许<code>Ⅱ</code>、<code>Ⅲ</code>类户向绑定账户直接借记资金，银联支持<code>Ⅱ</code>、<code>Ⅲ</code>类账户与绑定账户间通过借记和贷记业务实现灵活便捷的资金划付。</li>
<li><strong>账户使用</strong>：<code>I</code>类账户、对面核实身份的<code>Ⅱ</code>类户可以发行实体银行卡，其他账户不能使用实体银行卡，<code>Ⅱ</code>、<code>Ⅲ</code>类户可以通过云闪付、二维码等支付工具来完成支付，银联支持<code>Ⅱ</code>、<code>Ⅲ</code>类账户便捷生成基于安全芯片、主机卡模拟或二维码等技术的支付工具。</li>
</ul>
<h4>4.3 账户建模 <a href="#t13" id="t13"></a></h4>
<p>在支付系统中，账户的建模，主要是从如下几个方面来考虑：</p>
<ul>
<li><strong>交易的需求</strong>，比如检查账户是否被锁定、余额是否足够、是否有效等。</li>
<li><strong>记账的需求</strong>，按照公司会计需求记录账户上的所有行为，包括支出、充值、转账等。</li>
<li><strong>对账的需求</strong>，包括和支付渠道、商户、个人的对账需求，核对交易和账户余额是否正确。</li>
<li><strong>风控的需求</strong>，如反洗钱、反欺诈等，都需要依赖于账户体系来提供核心数据。</li>
<li><strong>信用的需求</strong>，对用户、资产、商户等主体进行信用评估时，也需要依赖账户体系来提供的核心数据。</li>
</ul>
<p>这五个需求，按照其设计的优先级，也是从支付、记账、对账、风控来进行。 支付系统根据其发展所处的阶段，逐步将新增需求纳入设计中。说了这么多，目的是为了对账户建模。账户模型是和公司业务密切相关的，公司不同规模，发展的不同阶段需要不同的模型。从交易模型中可以衍生出针对各个角色的账户流水，即明细模型，用于支持对账。根据业务需要，可以设置多种账户，如支付账户、预付卡账户、代扣账户、零钱账户、结算账户等。从类别上来说，这里的账户，一般指总账账户。一般来说电商系统中涉及的账户类型有：</p>
<ul>
<li><strong>虚拟币账户</strong>：用户和使用虚拟币的商户都需要建立虚拟币账户；</li>
<li><strong>代扣账户</strong>： 用来支持订阅类型的定期代扣；</li>
<li><strong>零钱账户</strong>：电商的内部账号，用户、商户、清算单位需要建立零钱账户。</li>
<li><strong>第三方支付账户</strong>：用户在第三方支付机构建立的账户。</li>
<li><strong>银行卡账户</strong>：用户的银行卡信息，每个卡对应一个账户。</li>
<li><strong>结算账户</strong>：用来支持和第三方支付公司、银行进行结算用，第三方支付需要为每个商户号建立结算账户；银行需要为借记卡、贷记卡分别建立结算账户，一般在银行卡直连时使用。</li>
<li><strong>代扣代缴账户</strong>：用来支持代扣税款业务。</li>
</ul>
<p>对这些账户，需要设置如下属性，基本属性，包括：</p>
<ul>
<li><strong>账户号或称为账户 ID</strong>，一般是系统自动生成。特别注意的是，要事先约定好账户 ID 的规则，比如头三位用来表示账户类型，后几位用来表示账户编号等，务必保证根据账号号能够快速确定账户类型，并且保证账户号是不重复的。</li>
<li><strong>账户名称</strong>，一般是由用户自己设置的，显示用。</li>
<li><strong>账户使用的货币类型</strong>，注意虽然一张银行卡可以支持多个币种，实际在内部，还是针对每个币种建立独立的子账户。涉及到多币种的账户，也可以采用类似的建模方案。</li>
<li><strong>会计科目代码</strong>，一般是一级会计科目的代码。</li>
</ul>
<p>账户控制相关：</p>
<ul>
<li>是否允许充值；</li>
<li>是否允许提现；</li>
<li>是否允许透支；</li>
<li>是否允许支付；</li>
<li>是否允许转账进入；</li>
<li>是否允许转账转出；</li>
<li>是否有安全保障；</li>
<li>是否激活；</li>
<li>是否冻结。</li>
</ul>
<p>资金相关：</p>
<ul>
<li>当前账户余额，等于可用余额+冻结余额；</li>
<li>当前账户可用余额；</li>
<li>当前账户冻结的余额，冻结余额指在账户上暂不能使用的额度。在支付的时候，往往是先冻结，商品出库后，再实际执行扣款。</li>
</ul>
<p>银行卡、第三方支付信息：</p>
<ul>
<li>第三方实体的 ID；</li>
<li>第三方账号，如银行卡号或者在第三方支付的<code>open_id</code>等；</li>
<li>第三方的<code>app_id</code>；</li>
<li>账号的失效日期，该账号什么时候失效。</li>
</ul>
<p>注意，有些第三方信息是不能保存的，如用户的账号密码、信用卡的 CV 号等。为了避免账户信息被爬库或者数据库信息意外泄露，一般还需要对敏感字段，如密码等，进行加密保存，甚至保存到另外的表中。更进一步，为了避免账户信息被意外修改，还可以增加一个校验字段，在写入数据时设置该字段，在读取数据时做校验，一旦发现数据有问题，则关闭该账号。</p>
18:T1dfa,<p>接业务知识的上一篇文章：商业模式。</p>
<p>在上一篇文章中我们介绍了<strong>商业模式画布的九个模块</strong>。</p>
<p>商业模式画布是商业运作的<strong>战略</strong>模型，它确定了整个商业的大方向。</p>
<p>除了战略层面，<strong>为了使商业模式能够顺利运转，还需要战术层面的配合</strong>。关键业务就是商业模式中的一个重要模块，它包括我们日常需要做的一些事情来保证商业模式的正常运转。</p>
<p>关键业务通常由中层管理人员负责，他们会对这些工作进行梳理，并建立起业务模型。</p>
<p>今天，我们将讨论<strong>业务模型。</strong></p>
<h2>01 关键业务的类型</h2>
<p>商业模式画布中的关键业务可以分为生产、销售、交付以及其他配套的基础工具和系统。下面分别介绍这些业务类型：</p>
<ul>
<li><strong>生产制造业务</strong>：涉及到产品设计、原材料采购、生产制造、品质控制等方面，是制造企业的核心业务。例如，知识付费类的业务需要进行课程生产。</li>
<li><strong>销售渠道业务</strong>：涉及到产品销售、渠道管理、售后服务等方面。</li>
<li><strong>产品交付业务</strong>：涉及到订单管理、产品服务、服务履约等方面。</li>
</ul>
<p>除此之外，围绕着这三大种业务类型还会有配套的基础工具和系统，例如运营（人力、财务等）、研发、平台建设等，用以提高效率和提升业务水平。比如：</p>
<ul>
<li>**平台技术业务：**涉及到平台建设、技术开发、数据管理等方面，是互联网企业的核心业务。</li>
<li>**运营管理业务：**涉及到人力资源、财务管理、法务合规等方面，是企业运营管理的核心业务。</li>
<li>**研究开发业务：**涉及到技术研发、创新设计等方面，是科技型企业的核心业务。</li>
</ul>
<p>这些业务类型是商业模式画布中常见的关键业务类型，不同的企业根据自身特点和行业属性，可能会存在不同的关键业务类型。</p>
<h2>02 业务模型</h2>
<p>一般来说业务模型是一个SOP，SOP（Standard Operation Procedure）是标准作业程序的简称。</p>
<p><strong>SOP有三个关键要素。</strong></p>
<p>首先是<strong>标准</strong>，这就像一把衡量工作成果的尺子，告诉我们是达标还是不达标。每个人对事物的认知能力都是不同的，如果没有一个明确的标准，就会导致沟通不畅，影响工作效率。在一个公司中，员工是执行者，如果每个员工按照自己的标准来解决问题，客户的需求将无法得到满足，不利于公司管理。因此，制定SOP的第一个要素是明确的标准，这有助于规范员工行为，提高执行效率。</p>
<p>其次是<strong>流程</strong>，这个过程从零到一，每一步都重要，顺序不可逆。如果流程出现偏差，即使销售人员的能力再强，也会影响到最终的结果。例如，建立信任是非常重要的一步，不应该在还不熟悉客户的情况下贸然报价。因此，制定SOP的第二个要素是流程，必须对每个步骤进行细化和量化，制定出标准，以便在推进业务进程时提高效率。</p>
<p>第三个要素是<strong>可操作性</strong>，标准和流程必须在可操作的基础上进行。制定SOP的初衷是为了规范员工日常工作，提高工作效率，因此，SOP必须简单直观，任何员工都可以看懂且快速上手。SOP制定不应该过于复杂庞大，而应该以清晰为主，即使是新员工也可以凭借SOP对流程了解七八分，这才是成功的SOP。</p>
<p>SOP就像是机器运行的规则，而一家公司的运转依赖于许多不同的SOP组合，以确保公司的正常运转。</p>
<h2>03 常见的业务模型</h2>
<h3>1、生产</h3>
<p>一个企业的产品和服务需要生产，需要一个稳定的生产流程确保有稳定的产品或服务质量。</p>
<p>以知识付费课程的生产为例，一般的<strong>课程生产SOP大致如下：</strong></p>
<ol>
<li>明确课程目标和范围。</li>
<li>制定教学大纲和教学计划。</li>
<li>编写教材和课件。</li>
<li>录制课程视频。</li>
<li>制作课程配套材料。</li>
<li>进行内部审核和修改。</li>
<li>进行试教和修改。</li>
<li>上线发布和推广。</li>
<li>进行售后服务和维护。</li>
<li>进行课程评估和改进。</li>
</ol>
<p>课程的制作是一个相对具有创造性的工作，但实际上仍需要遵循严格的流程管理。据说，像好莱坞电影这样的具有创意性的企业，在制作电影时也会按照严格的流水线制作方式来确保电影质量。</p>
<h3>2、销售</h3>
<p>企业的盈利离不开销售，销售的类型很多，有分销、直销、线上销售、线下零售、代理商渠道等等。</p>
<p>不同的销售类型对应的销售流程也不一样。</p>
<p>我们还是知识付费产品为例，<strong>分销渠道的SOP大致如下</strong>：</p>
<ol>
<li>明确分销渠道的目标和范围。</li>
<li>寻找合适的分销渠道伙伴。</li>
<li>确定分销合作方式和细则。</li>
<li>提供产品及相关资料。</li>
<li>培训分销渠道伙伴。</li>
<li>跟进分销渠道伙伴的销售情况。</li>
<li>分成结算和售后服务。</li>
<li>评估分销渠道伙伴的表现。</li>
</ol>
<h3>3、交付</h3>
<p>交付是指销售之后，如何把产品交给用户。比如电商下单后，需要通过快递公司快递包裹给用户。销售不是购买力促恒的结束，交付才是一个购买流程的完结。</p>
<p>知识付费产品的<strong>交付SOP</strong>大致如下：</p>
<ol>
<li>确认用户的支付信息。</li>
<li>验证用户的身份信息。</li>
<li>生成课程访问链接。</li>
<li>提供课程资料及学习指导。</li>
<li>确认课程交付。</li>
<li>处理退款及退课请求。</li>
<li>记录用户反馈和课程效果。</li>
</ol>
<h3>4、其他辅助业务</h3>
<p>生产、销售、交付是最为基础并且关键的业务，没有这些业务的支持，企业将无法正常运转。这些流程的顺畅与否直接影响到企业的经济效益和发展。</p>
<p>除了以上业务，还有其他一些业务是<strong>以上业务的辅助，分别是基础业务和效率提升业务。</strong></p>
<p>基础业务是支撑整个流程的基础，如人力资源、财务、行政等。没有这些基础业务，企业的其他业务根本无法开展。</p>
<p>另外，为了提高流程的效率，企业需要采取一些措施，如平台建设、数据分析等。比如建设中台，它可以为企业提供更高效的信息共享平台，提升其他业务的工作效率，提高企业的整体竞争力。</p>
<p>因此，企业必须注意对基础流程和基础业务的管理和提升，才能更好地发展。</p>
<h2>04 小结</h2>
<p><strong>商业模式画布是商业运营的战略，而关键业务则是商业运营的战术。</strong></p>
<p>许多从事职场工作的人，往往被琐碎的日常工作所束缚，只关注于自己所做的事情，而缺乏对整个业务的全貌认知。虽然他们知道产品的意义、运营的作用以及技术的功能，但是缺乏将这些知识融合起来的能力。</p>
<p>通过最近一些业务知识的学习，我们可以了解到企业的战略和战术，从而有助于我们<strong>制定指标体系、寻找业务机会以及提高工作价值</strong>。</p>
19:T824e,<h3>整体思考 <a href="#item-0-2" id="item-0-2"></a></h3>
<h4>1 秒杀存在的问题 <a href="#item-0-3" id="item-0-3"></a></h4>
<p>对于一个日常平稳的业务系统，如果直接开通秒杀功能的话，往往会出现很多问题——</p>
<table>
<thead>
<tr>
<th>干系人</th>
<th>问题分类</th>
<th>业务出现的问题</th>
<th>设计要求</th>
</tr>
</thead>
<tbody><tr>
<td>用户</td>
<td>体验较差</td>
<td>秒杀开始，系统瞬间承受平时数十倍甚至上百倍的流量，直接宕掉</td>
<td>高性能</td>
</tr>
<tr>
<td></td>
<td></td>
<td>用户下单后却付不了款，显示商品已经被其他人买走了</td>
<td>一致性</td>
</tr>
<tr>
<td>商家</td>
<td>商品超卖</td>
<td>100 件商品，却出现 200 人下单成功，成功下单买到商品的人数远远超过活动商品数量的上限</td>
<td>一致性</td>
</tr>
<tr>
<td></td>
<td>资金受损</td>
<td>竞争对手通过恶意下单的方式将活动商品全部下单，导致库存清零，商家无法正常售卖</td>
<td>高可用</td>
</tr>
<tr>
<td></td>
<td></td>
<td>秒杀器猖獗，黄牛通过秒杀器扫货，商家无法达到营销目的</td>
<td>高可用</td>
</tr>
<tr>
<td>平台</td>
<td>风险不可控</td>
<td>系统的其它与秒杀活动不相关的模块变得异常缓慢，业务影响面扩散</td>
<td>高可用</td>
</tr>
<tr>
<td></td>
<td>拖垮网站</td>
<td>在线人数创新高，核心链路涉及的上下游服务从前到后都在告警</td>
<td>高性能</td>
</tr>
<tr>
<td></td>
<td></td>
<td>库存只有一份，所有请求集中读写同一个数据，DB 出现单点</td>
<td>高性能</td>
</tr>
</tbody></table>
<h4>2 设计方向的思考 <a href="#item-0-4" id="item-0-4"></a></h4>
<p>秒杀本质是要求一个瞬时高发下的承压系统，这也是其区别于其他业务的核心场景。对日常系统秒杀产生的问题逐一进行拆解分类，秒杀对应到架构设计，其实就是高可用、一致性和高性能的要求。关于秒杀系统的设计思考，本文即基于此 3 层依次推进，简述如下——</p>
<ul>
<li>高性能。 秒杀涉及高读和高写的支持，如何支撑高并发，如何抵抗高IOPS？核心优化理念其实是类似的：高读就尽量&quot;少读&quot;或&quot;读少&quot;，高写就数据拆分。本文将从动静分离、热点优化以及服务端性能优化 3 个方面展开</li>
<li>一致性。 秒杀的核心关注是商品库存，有限的商品在同一时间被多个请求同时扣减，而且要保证准确性，显而易见是一个难题。如何做到既不多又不少？本文将从业界通用的几种减库存方案切入，讨论一致性设计的核心逻辑</li>
<li>高可用。 大型分布式系统在实际运行过程中面对的工况是非常复杂的，业务流量的突增、依赖服务的不稳定、应用自身的瓶颈、物理资源的损坏等方方面面都会对系统的运行带来大大小小的的冲击。如何保障应用在复杂工况环境下还能高效稳定运行，如何预防和面对突发问题，系统设计时应该从哪些方面着手？本文将从架构落地的全景视角进行关注思考</li>
</ul>
<h3>高性能 <a href="#item-0-5" id="item-0-5"></a></h3>
<h4>1 动静分离 <a href="#item-0-6" id="item-0-6"></a></h4>
<p>大家可能会注意到，秒杀过程中你是不需要刷新整个页面的，只有时间在不停跳动。这是因为一般都会对大流量的秒杀系统做系统的静态化改造，即数据意义上的动静分离。动静分离三步走：1、数据拆分；2、静态缓存；3、数据整合。</p>
<p><strong>1.1 数据拆分</strong></p>
<p>动静分离的首要目的是将动态页面改造成适合缓存的静态页面。因此第一步就是分离出动态数据，主要从以下 2 个方面进行：</p>
<ol>
<li>用户。用户身份信息包括登录状态以及登录画像等，相关要素可以单独拆分出来，通过动态请求进行获取；与之相关的广平推荐，如用户偏好、地域偏好等，同样可以通过异步方式进行加载</li>
<li>时间。秒杀时间是由服务端统一管控的，可以通过动态请求进行获取</li>
</ol>
<p>这里你可以打开电商平台的一个秒杀页面，看看这个页面里都有哪些动静数据。</p>
<p><strong>1.2 静态缓存</strong></p>
<p>分离出动静态数据之后，第二步就是将静态数据进行合理的缓存，由此衍生出两个问题：1、怎么缓存；2、哪里缓存</p>
<p><strong>1.2.1 怎么缓存</strong></p>
<p>静态化改造的一个特点是直接缓存整个 HTTP 连接而不是仅仅缓存静态数据，如此一来，Web 代理服务器根据请求 URL，可以直接取出对应的响应体然后直接返回，响应过程无需重组 HTTP 协议，也无需解析 HTTP 请求头。而作为缓存键，URL唯一化是必不可少的，只是对于商品系统，URL 天然是可以基于商品 ID 来进行唯一标识的，比如淘宝的 <a href="https://link.segmentfault.com/?enc=MYTx%2B1O98e0H2OhCbw2yrg%3D%3D.eRmrBGs8O3Hv0%2BVZ4yO3J8RpgwhKne1xP0L6oRT4KFKWY4nTZucRo5o6QTC3xhtN">https://item.taobao.com/item....</a>。</p>
<p><strong>1.2.2 哪里缓存</strong></p>
<p>静态数据缓存到哪里呢？可以有三种方式：1、浏览器；2、CDN ；3、服务端。</p>
<p>浏览器当然是第一选择，但用户的浏览器是不可控的，主要体现在如果用户不主动刷新，系统很难主动地把消息推送给用户（注意，当讨论静态数据时，潜台词是 “相对不变”，言外之意是 “可能会变”），如此可能会导致用户端在很长一段时间内看到的信息都是错误的。对于秒杀系统，保证缓存可以在秒级时间内失效是不可或缺的。</p>
<p>服务端主要进行动态逻辑计算及加载，本身并不擅长处理大量连接，每个连接消耗内存较多，同时 Servlet 容器解析 HTTP 较慢，容易侵占逻辑计算资源；另外，静态数据下沉至此也会拉长请求路径。</p>
<p>因此通常将静态数据缓存在 CDN，其本身更擅长处理大并发的静态文件请求，既可以做到主动失效，又离用户尽可能近，同时规避 Java 语言层面的弱点。需要注意的是，上 CDN 有以下几个问题需要解决：</p>
<ol>
<li>失效问题。任何一个缓存都应该是有时效的，尤其对于一个秒杀场景。所以，系统需要保证全国各地的 CDN 在秒级时间内失效掉缓存信息，这实际对 CDN 的失效系统要求是很高的</li>
<li>命中率问题。高命中是缓存系统最为核心的性能要求，不然缓存就失去了意义。如果将数据放到全国各地的 CDN ，势必会导致请求命中同一个缓存的可能性降低，那么命中率就成为一个问题</li>
</ol>
<p>因此，将数据放到全国所有的 CDN 节点是不太现实的，失效问题、命中率问题都会面临比较大的挑战。更为可行的做法是选择若干 CDN 节点进行静态化改造，节点的选取通常需要满足以下几个条件：</p>
<ol>
<li>临近访问量集中的地区</li>
<li>距离主站较远的地区</li>
<li>节点与主站间网络质量良好的地区</li>
</ol>
<p>基于以上因素，选择 CDN 的二级缓存比较合适，因为二级缓存数量偏少，容量也更大，访问量相对集中，这样就可以较好解决缓存的失效问题以及命中率问题，是当前比较理想的一种 CDN 化方案。部署方式如下图所示：</p>
<p><img src="/images/blog/engineering/system-image_1_2.png" alt="image_1_2.png"></p>
<p><strong>1.3 数据整合</strong></p>
<p>分离出动静态数据之后，前端如何组织数据页就是一个新的问题，主要在于动态数据的加载处理，通常有两种方案：ESI（Edge Side Includes）方案和 CSI（Client Side Include）方案。</p>
<ol>
<li>ESI 方案：Web 代理服务器上请求动态数据，并将动态数据插入到静态页面中，用户看到页面时已经是一个完整的页面。这种方式对服务端性能要求高，但用户体验较好</li>
<li>CSI 方案：Web 代理服务器上只返回静态页面，前端单独发起一个异步 JS 请求动态数据。这种方式对服务端性能友好，但用户体验稍差</li>
</ol>
<p><strong>1.4 小结</strong></p>
<p>动静分离对于性能的提升，抽象起来只有两点，一是数据要尽量少，以便减少没必要的请求，二是路径要尽量短，以便提高单次请求的效率。具体方法其实就是基于这个大方向进行的。</p>
<h4>2 热点优化 <a href="#item-0-7" id="item-0-7"></a></h4>
<p>热点分为热点操作和热点数据，以下分开进行讨论。</p>
<p><strong>2.1 热点操作</strong></p>
<p>零点刷新、零点下单、零点添加购物车等都属于热点操作。热点操作是用户的行为，不好改变，但可以做一些限制保护，比如用户频繁刷新页面时进行提示阻断。</p>
<p><strong>2.2 热点数据</strong></p>
<p>热点数据的处理三步走，一是热点识别，二是热点隔离，三是热点优化。</p>
<p><strong>2.2.1 热点识别</strong></p>
<p>热点数据分为静态热点和动态热点，具体如下：</p>
<ol>
<li>静态热点：能够提前预测的热点数据。大促前夕，可以根据大促的行业特点、活动商家等纬度信息分析出热点商品，或者通过卖家报名的方式提前筛选；另外，还可以通过技术手段提前预测，例如对买家每天访问的商品进行大数据计算，然后统计出 TOP N 的商品，即可视为热点商品</li>
<li>动态热点：无法提前预测的热点数据。冷热数据往往是随实际业务场景发生交替变化的，尤其是如今直播卖货模式的兴起——带货商临时做一个广告，就有可能导致一件商品在短时间内被大量购买。由于此类商品日常访问较少，即使在缓存系统中一段时间后也会被逐出或过期掉，甚至在db中也是冷数据。瞬时流量的涌入，往往导致缓存被击穿，请求直接到达DB，引发DB压力过大</li>
</ol>
<p>因此秒杀系统需要实现热点数据的动态发现能力，一个常见的实现思路是：</p>
<ol>
<li>异步采集交易链路各个环节的热点 Key 信息，如 Nginx采集访问URL或 Agent 采集热点日志（一些中间件本身已具备热点发现能力），提前识别潜在的热点数据</li>
<li>聚合分析热点数据，达到一定规则的热点数据，通过订阅分发推送到链路系统，各系统根据自身需求决定如何处理热点数据，或限流或缓存，从而实现热点保护</li>
</ol>
<p>需要注意的是：</p>
<ol>
<li>热点数据采集最好采用异步方式，一方面不会影响业务的核心交易链路，一方面可以保证采集方式的通用性</li>
<li>热点发现最好做到秒级实时，这样动态发现才有意义，实际上也是对核心节点的数据采集和分析能力提出了较高的要求</li>
</ol>
<p><strong>2.2.2 热点隔离</strong></p>
<p>热点数据识别出来之后，第一原则就是将热点数据隔离出来，不要让 1% 影响到另外的 99%，可以基于以下几个层次实现热点隔离：</p>
<ol>
<li>业务隔离。秒杀作为一种营销活动，卖家需要单独报名，从技术上来说，系统可以提前对已知热点做缓存预热</li>
<li>系统隔离。系统隔离是运行时隔离，通过分组部署和另外 99% 进行分离，另外秒杀也可以申请单独的域名，入口层就让请求落到不同的集群中</li>
<li>数据隔离。秒杀数据作为热点数据，可以启用单独的缓存集群或者DB服务组，从而更好的实现横向或纵向能力扩展</li>
</ol>
<p>当然，实现隔离还有很多种办法。比如，可以按照用户来区分，为不同的用户分配不同的 Cookie，入口层路由到不同的服务接口中；再比如，域名保持一致，但后端调用不同的服务接口；又或者在数据层给数据打标进行区分等等，这些措施的目的都是把已经识别的热点请求和普通请求区分开来。</p>
<p><strong>2.2.3 热点优化</strong></p>
<p>热点数据隔离之后，也就方便对这 1% 的请求做针对性的优化，方式无外乎两种：</p>
<ol>
<li>缓存：热点缓存是最为有效的办法。如果热点数据做了动静分离，那么可以长期缓存静态数据</li>
<li>限流：流量限制更多是一种保护机制。需要注意的是，各服务要时刻关注请求是否触发限流并及时进行review</li>
</ol>
<p><strong>2.2.4 小结</strong></p>
<p>数据的热点优化与动静分离是不一样的，热点优化是基于二八原则对数据进行了纵向拆分，以便进行针对性地处理。热点识别和隔离不仅对“秒杀”这个场景有意义，对其他的高性能分布式系统也非常有参考价值。</p>
<h4>3 系统优化 <a href="#item-0-8" id="item-0-8"></a></h4>
<p>对于一个软件系统，提高性能可以有很多种手段，如提升硬件水平、调优JVM 性能，这里主要关注代码层面的性能优化——</p>
<ol>
<li>减少序列化：减少 Java 中的序列化操作可以很好的提升系统性能。序列化大部分是在 RPC 阶段发生，因此应该尽量减少 RPC 调用，一种可行的方案是将多个关联性较强的应用进行 “合并部署”，从而减少不同应用之间的 RPC 调用（微服务设计规范）</li>
<li>直接输出流数据：只要涉及字符串的I/O操作，无论是磁盘 I/O 还是网络 I/O，都比较耗费 CPU 资源，因为字符需要转换成字节，而这个转换又必须查表编码。所以对于常用数据，比如静态字符串，推荐提前编码成字节并缓存，具体到代码层面就是通过 OutputStream() 类函数从而减少数据的编码转换；另外，热点方法toString()不要直接调用ReflectionToString实现，推荐直接硬编码，并且只打印DO的基础要素和核心要素</li>
<li>裁剪日志异常堆栈：无论是外部系统异常还是应用本身异常，都会有堆栈打出，超大流量下，频繁的输出完整堆栈，只会加剧系统当前负载。可以通过日志配置文件控制异常堆栈输出的深度</li>
<li>去组件框架：极致优化要求下，可以去掉一些组件框架，比如去掉传统的 MVC 框架，直接使用 Servlet 处理请求。这样可以绕过一大堆复杂且用处不大的处理逻辑，节省毫秒级的时间，当然，需要合理评估你对框架的依赖程度</li>
</ol>
<h4>4 总结一下 <a href="#item-0-9" id="item-0-9"></a></h4>
<p>性能优化需要一个基准值，所以系统还需要做好应用基线，比如性能基线（何时性能突然下降）、成本基线（去年大促用了多少机器）、链路基线（核心流程发生了哪些变化），通过基线持续关注系统性能，促使系统在代码层面持续提升编码质量、业务层面及时下掉不合理调用、架构层面不断优化改进。</p>
<h3>一致性 <a href="#item-0-10" id="item-0-10"></a></h3>
<p>秒杀系统中，库存是个关键数据，卖不出去是个问题，超卖更是个问题。秒杀场景下的一致性问题，主要就是库存扣减的准确性问题。</p>
<h4>1 减库存的方式 <a href="#item-0-11" id="item-0-11"></a></h4>
<p>电商场景下的购买过程一般分为两步：下单和付款。“提交订单”即为下单，“支付订单”即为付款。基于此设定，减库存一般有以下几个方式：</p>
<ol>
<li>下单减库存。买家下单后，扣减商品库存。下单减库存是最简单的减库存方式，也是控制最为精确的一种</li>
<li>付款减库存。买家下单后，并不立即扣减库存，而是等到付款后才真正扣减库存。但因为付款时才减库存，如果并发比较高，可能出现买家下单后付不了款的情况，因为商品已经被其他人买走了</li>
<li>预扣库存。这种方式相对复杂一些，买家下单后，库存为其保留一定的时间（如 15 分钟），超过这段时间，库存自动释放，释放后其他买家可以购买</li>
</ol>
<p>能够看到，减库存方式是基于购物过程的多阶段进行划分的，但无论是在下单阶段还是付款阶段，都会存在一些问题，下面进行具体分析。</p>
<h4>2 减库存的问题 <a href="#item-0-12" id="item-0-12"></a></h4>
<p><strong>2.1 下单减库存</strong></p>
<p>优势：用户体验最好。下单减库存是最简单的减库存方式，也是控制最精确的一种。下单时可以直接通过数据库事务机制控制商品库存，所以一定不会出现已下单却付不了款的情况。</p>
<p>劣势：可能卖不出去。正常情况下，买家下单后付款概率很高，所以不会有太大问题。但有一种场景例外，就是当卖家参加某个促销活动时，竞争对手通过恶意下单的方式将该商品全部下单，导致库存清零，那么这就不能正常售卖了——要知道，恶意下单的人是不会真正付款的，这正是 “下单减库存” 的不足之处。</p>
<p><strong>2.2 付款减库存</strong></p>
<p>优势：一定实际售卖。“下单减库存” 可能导致恶意下单，从而影响卖家的商品销售， “付款减库存” 由于需要付出真金白银，可以有效避免。</p>
<p>劣势：用户体验较差。用户下单后，不一定会实际付款，假设有 100 件商品，就可能出现 200 人下单成功的情况，因为下单时不会减库存，所以也就可能出现下单成功数远远超过真正库存数的情况，这尤其会发生在大促的热门商品上。如此一来就会导致很多买家下单成功后却付不了款，购物体验自然是比较差的。</p>
<p><strong>2.3 预扣库存</strong></p>
<p>优势：缓解了以上两种方式的问题。预扣库存实际就是“下单减库存”和 “付款减库存”两种方式的结合，将两次操作进行了前后关联，下单时预扣库存，付款时释放库存。</p>
<p>劣势：并没有彻底解决以上问题。比如针对恶意下单的场景，虽然可以把有效付款时间设置为 10 分钟，但恶意买家完全可以在 10 分钟之后再次下单。</p>
<p><strong>2.4 小结</strong></p>
<p>减库存的问题主要体现在用户体验和商业诉求两方面，其本质原因在于购物过程存在两步甚至多步操作，在不同阶段减库存，容易存在被恶意利用的漏洞。</p>
<h4>3 实际如何减库存 <a href="#item-0-13" id="item-0-13"></a></h4>
<p>业界最为常见的是预扣库存。无论是外卖点餐还是电商购物，下单后一般都有个 “有效付款时间”，超过该时间订单自动释放，这就是典型的预扣库存方案。但如上所述，预扣库存还需要解决恶意下单的问题，保证商品卖的出去；另一方面，如何避免超卖，也是一个痛点。</p>
<ol>
<li>卖的出去：恶意下单的解决方案主要还是结合安全和反作弊措施来制止。比如，识别频繁下单不付款的买家并进行打标，这样可以在打标买家下单时不减库存；再比如为大促商品设置单人最大购买件数，一人最多只能买 N 件商品；又或者对重复下单不付款的行为进行次数限制阻断等</li>
<li>避免超卖：库存超卖的情况实际分为两种。对于普通商品，秒杀只是一种大促手段，即使库存超卖，商家也可以通过补货来解决；而对于一些商品，秒杀作为一种营销手段，完全不允许库存为负，也就是在数据一致性上，需要保证大并发请求时数据库中的库存字段值不能为负，一般有多种方案：一是在通过事务来判断，即保证减后库存不能为负，否则就回滚；二是直接设置数据库字段类型为无符号整数，这样一旦库存为负就会在执行 SQL 时报错；三是使用 CASE WHEN 判断语句——</li>
</ol>
<pre><code class="language-sql">UPDATE item SET inventory = CASE WHEN inventory &gt;= xxx THEN inventory-xxx ELSE inventory END
</code></pre>
<p>业务手段保证商品卖的出去，技术手段保证商品不会超卖，库存问题从来就不是简单的技术难题，解决问题的视角是多种多样的。</p>
<h4>4 一致性性能的优化 <a href="#item-0-14" id="item-0-14"></a></h4>
<p>库存是个关键数据，更是个热点数据。对系统来说，热点的实际影响就是 “高读” 和 “高写”，也是秒杀场景下最为核心的一个技术难题。</p>
<p><strong>4.1 高并发读</strong></p>
<p>秒杀场景解决高并发读问题，关键词是“分层校验”。即在读链路时，只进行不影响性能的检查操作，如用户是否具有秒杀资格、商品状态是否正常、用户答题是否正确、秒杀是否已经结束、是否非法请求等，而不做一致性校验等容易引发瓶颈的检查操作；直到写链路时，才对库存做一致性检查，在数据层保证最终准确性。</p>
<p>因此，在分层校验设定下，系统可以采用分布式缓存甚至LocalCache来抵抗高并发读。即允许读场景下一定的脏数据，这样只会导致少量原本无库存的下单请求被误认为是有库存的，等到真正写数据时再保证最终一致性，由此做到高可用和一致性之间的平衡。</p>
<p>实际上，分层校验的核心思想是：不同层次尽可能过滤掉无效请求，只在“漏斗” 最末端进行有效处理，从而缩短系统瓶颈的影响路径。</p>
<p><strong>4.2 高并发写</strong></p>
<p>高并发写的优化方式，一种是更换DB选型，一种是优化DB性能，以下分别进行讨论。</p>
<p>4.2.1 更换DB选型</p>
<p>秒杀商品和普通商品的减库存是有差异的，核心区别在数据量级小、交易时间短，因此能否把秒杀减库存直接放到缓存系统中实现呢，也就是直接在一个带有持久化功能的缓存中进行减库存操作，比如 Redis？</p>
<p>如果减库存逻辑非常单一的话，比如没有复杂的 SKU 库存和总库存这种联动关系的话，个人认为是完全可以的。但如果有比较复杂的减库存逻辑，或者需要使用到事务，那就必须在数据库中完成减库存操作。</p>
<p>4.2.2 优化DB性能</p>
<p>库存数据落地到数据库实现其实是一行存储（MySQL），因此会有大量线程来竞争 InnoDB 行锁。但并发越高，等待线程就会越多，TPS 下降，RT 上升，吞吐量会受到严重影响——注意，这里假设数据库已基于上文【性能优化】完成数据隔离，以便于讨论聚焦 。</p>
<p>解决并发锁的问题，有两种办法：</p>
<ol>
<li>应用层排队。通过缓存加入集群分布式锁，从而控制集群对数据库同一行记录进行操作的并发度，同时也能控制单个商品占用数据库连接的数量，防止热点商品占用过多的数据库连接</li>
<li>数据层排队。应用层排队是有损性能的，数据层排队是最为理想的。业界中，阿里的数据库团队开发了针对InnoDB 层上的补丁程序（patch），可以基于DB层对单行记录做并发排队，从而实现秒杀场景下的定制优化——注意，排队和锁竞争是有区别的，如果熟悉 MySQL 的话，就会知道 InnoDB 内部的死锁检测，以及 MySQL Server 和 InnoDB 的切换都是比较消耗性能的。另外阿里的数据库团队还做了很多其他方面的优化，如 COMMIT_ON_SUCCESS 和 ROLLBACK_ON_FAIL 的补丁程序，通过在 SQL 里加入提示（hint），实现事务不需要等待实时提交，而是在数据执行完最后一条 SQL 后，直接根据 TARGET_AFFECT_ROW 的结果进行提交或回滚，减少网络等待的时间（毫秒级）。目前阿里已将包含这些补丁程序的 MySQL 开源：<a href="https://link.segmentfault.com/?enc=I%2FCSvHmwhqWWaIcvx%2BoGuw%3D%3D.9twostwyDIweyMcUrly3Zp6KPhQuFFX7eS%2FNY5bGVH3W2EN%2FLLcCmxl3cSe4rhiflb5yVJtZxmcjdRE5e2CqiLn7gsvN1ymwz5bAEmNgIr0%3D">AliSQL</a></li>
</ol>
<p><strong>4.3 小结</strong></p>
<p>高读和高写的两种处理方式大相径庭。读请求的优化空间要大一些，而写请求的瓶颈一般都在存储层，优化思路的本质还是基于 CAP 理论做平衡。</p>
<h4>5 总结一下 <a href="#item-0-15" id="item-0-15"></a></h4>
<p>当然，减库存还有很多细节问题，例如预扣的库存超时后如何进行回补，再比如第三方支付如何保证减库存和付款时的状态一致性，这些也是很大的挑战。</p>
<h3>高可用 <a href="#item-0-16" id="item-0-16"></a></h3>
<p>盯过秒杀流量监控的话，会发现它不是一条蜿蜒而起的曲线，而是一条挺拔的直线，这是因为秒杀请求高度集中于某一特定的时间点。这样一来就会造成一个特别高的零点峰值，而对资源的消耗也几乎是瞬时的。所以秒杀系统的可用性保护是不可或缺的。</p>
<h4>1 流量削峰 <a href="#item-0-17" id="item-0-17"></a></h4>
<p>对于秒杀的目标场景，最终能够抢到商品的人数是固定的，无论 100 人和 10000 人参加结果都是一样的，即有效请求额度是有限的。并发度越高，无效请求也就越多。但秒杀作为一种商业营销手段，活动开始之前是希望有更多的人来刷页面，只是真正开始后，秒杀请求不是越多越好。因此系统可以设计一些规则，人为的延缓秒杀请求，甚至可以过滤掉一些无效请求。</p>
<p><strong>1.1 答题</strong></p>
<p>早期秒杀只是简单的点击秒杀按钮，后来才增加了答题。为什么要增加答题呢？主要是通过提升购买的复杂度，达到两个目的：</p>
<ol>
<li>防止作弊。早期秒杀器比较猖獗，存在恶意买家或竞争对手使用秒杀器扫货的情况，商家没有达到营销的目的，所以增加答题来进行限制</li>
<li>延缓请求。零点流量的起效时间是毫秒级的，答题可以人为拉长峰值下单的时长，由之前的 &lt;1s 延长到 &lt;10s。这个时间对于服务端非常重要，会大大减轻高峰期并发压力；另外，由于请求具有先后顺序，答题后置的请求到来时可能已经没有库存了，因此根本无法下单，此阶段落到数据层真正的写也就非常有限了</li>
</ol>
<p>需要注意的是，答题除了做正确性验证，还需要对提交时间做验证，比如&lt;1s 人为操作的可能性就很小，可以进一步防止机器答题的情况。</p>
<p>答题目前已经使用的非常普遍了，本质是通过在入口层削减流量，从而让系统更好地支撑瞬时峰值。</p>
<p><strong>1.2 排队</strong></p>
<p>最为常见的削峰方案是使用消息队列，通过把同步的直接调用转换成异步的间接推送缓冲瞬时流量。除了消息队列，类似的排队方案还有很多，例如：</p>
<ol>
<li>线程池加锁等待</li>
<li>本地内存蓄洪等待</li>
<li>本地文件序列化写，再顺序读</li>
</ol>
<p>排队方式的弊端也是显而易见的，主要有两点：</p>
<ol>
<li>请求积压。流量高峰如果长时间持续，达到了队列的水位上限，队列同样会被压垮，这样虽然保护了下游系统，但是和请求直接丢弃也没多大区别</li>
<li>用户体验。异步推送的实时性和有序性自然是比不上同步调用的，由此可能出现请求先发后至的情况，影响部分敏感用户的购物体验</li>
</ol>
<p>排队本质是在业务层将一步操作转变成两步操作，从而起到缓冲的作用，但鉴于此种方式的弊端，最终还是要基于业务量级和秒杀场景做出妥协和平衡。</p>
<p><strong>1.3 过滤</strong></p>
<p>过滤的核心结构在于分层，通过在不同层次过滤掉无效请求，达到数据读写的精准触发。常见的过滤主要有以下几层：</p>
<p>1、读限流：对读请求做限流保护，将超出系统承载能力的请求过滤掉 2、读缓存：对读请求做数据缓存，将重复的请求过滤掉 3、写限流：对写请求做限流保护，将超出系统承载能力的请求过滤掉 4、写校验：对写请求做一致性校验，只保留最终的有效数据</p>
<p>过滤的核心目的是通过减少无效请求的数据IO保障有效请求的IO性能。</p>
<p><strong>1.4 小结</strong></p>
<p>系统可以通过入口层的答题、业务层的排队、数据层的过滤达到流量削峰的目的，本质是在寻求商业诉求与架构性能之间的平衡。另外，新的削峰手段也层出不穷，以业务切入居多，比如零点大促时同步发放优惠券或发起抽奖活动，将一部分流量分散到其他系统，这样也能起到削峰的作用。</p>
<h4>2 Plan B <a href="#item-0-18" id="item-0-18"></a></h4>
<p>当一个系统面临持续的高峰流量时，其实是很难单靠自身调整来恢复状态的，日常运维没有人能够预估所有情况，意外总是无法避免。尤其在秒杀这一场景下，为了保证系统的高可用，必须设计一个 Plan B 方案来进行兜底。</p>
<p>高可用建设，其实是一个系统工程，贯穿在系统建设的整个生命周期。</p>
<p><img src="/images/blog/engineering/system-image_1_1.png" alt="image_1_1.png"></p>
<p>具体来说，系统的高可用建设涉及架构阶段、编码阶段、测试阶段、发布阶段、运行阶段，以及故障发生时，逐一进行分析：</p>
<ol>
<li>架构阶段：考虑系统的可扩展性和容错性，避免出现单点问题。例如多地单元化部署，即使某个IDC甚至地市出现故障，仍不会影响系统运转</li>
<li>编码阶段：保证代码的健壮性，例如RPC调用时，设置合理的超时退出机制，防止被其他系统拖垮，同时也要对无法预料的返回错误进行默认的处理</li>
<li>测试阶段：保证CI的覆盖度以及Sonar的容错率，对基础质量进行二次校验，并定期产出整体质量的趋势报告</li>
<li>发布阶段：系统部署最容易暴露错误，因此要有前置的checklist模版、中置的上下游周知机制以及后置的回滚机制</li>
<li>运行阶段：系统多数时间处于运行态，最重要的是运行时的实时监控，及时发现问题、准确报警并能提供详细数据，以便排查问题</li>
<li>故障发生：首要目标是及时止损，防止影响面扩大，然后定位原因、解决问题，最后恢复服务</li>
</ol>
<p>对于日常运维而言，高可用更多是针对运行阶段而言的，此阶段需要额外进行加强建设，主要有以下几种手段：</p>
<ol>
<li>预防：建立常态压测体系，定期对服务进行单点压测以及全链路压测，摸排水位</li>
<li>管控：做好线上运行的降级、限流和熔断保护。需要注意的是，无论是限流、降级还是熔断，对业务都是有损的，所以在进行操作前，一定要和上下游业务确认好再进行。就拿限流来说，哪些业务可以限、什么情况下限、限流时间多长、什么情况下进行恢复，都要和业务方反复确认</li>
<li>监控：建立性能基线，记录性能的变化趋势；建立报警体系，发现问题及时预警</li>
<li>恢复：遇到故障能够及时止损，并提供快速的数据订正工具，不一定要好，但一定要有</li>
</ol>
<p>在系统建设的整个生命周期中，每个环节中都可能犯错，甚至有些环节犯的错，后面是无法弥补的或者成本极高的。所以高可用是一个系统工程，必须放到整个生命周期中进行全面考虑。同时，考虑到服务的增长性，高可用更需要长期规划并进行体系化建设。</p>
<h4>3 总结一下 <a href="#item-0-19" id="item-0-19"></a></h4>
<p>高可用其实是在说 “稳定性”，稳定性是一个平时不重要，但出了问题就要命的事情，然而它的落地又是一个问题——平时业务发展良好，稳定性建设就会降级给业务让路。解决这个问题必须在组织上有所保障，比如让业务负责人背上稳定性绩效指标，同时在部门中建立稳定性建设小组，小组成员由每条线的核心力量兼任，绩效由稳定性负责人来打分，这样就可以把体系化的建设任务落实到具体的业务系统中了。</p>
<h3>个人总结 <a href="#item-0-20" id="item-0-20"></a></h3>
<p>一个秒杀系统的设计，可以根据不同级别的流量，由简单到复杂打造出不同的架构，本质是各方面的取舍和权衡。当然，你可能注意到，本文并没有涉及具体的选型方案，因为这些对于架构来说并不重要，作为架构师，应该时刻提醒自己主线是什么。</p>
<p>同时也在这里抽象、提炼一下，主要是个人对于秒杀设计的提纲式整理，方便各位同学进行参考——!</p>
<p><img src="/images/blog/engineering/system-image_1_3.png" alt="image_1_3.png"></p>
5:["$","article",null,{"className":"min-h-screen","children":["$","div",null,{"className":"mx-auto max-w-6xl px-4 sm:px-6 lg:px-8 py-8","children":["$","div",null,{"className":"rounded-2xl shadow-2xl border border-gray-200 hover:shadow-3xl transition-all duration-300 p-8 sm:p-12","children":[["$","header",null,{"className":"mb-8","children":[["$","nav",null,{"className":"flex items-center gap-1 text-sm mb-4","children":[["$","$L13",null,{"href":"/blog/page/1","className":"text-gray-500 hover:text-blue-600 transition-colors","children":"博客"}],["$","span",null,{"className":"text-gray-300","children":"/"}],["$","$L13",null,{"href":"/blog/category/engineering/page/1","className":"text-gray-500 hover:text-blue-600 transition-colors","children":"Engineering"}],[["$","span",null,{"className":"text-gray-300","children":"/"}],["$","$L13",null,{"href":"/blog/category/engineering/architecture/page/1","className":"text-blue-600 hover:text-blue-700 transition-colors","children":"架构设计"}]]]}],["$","div",null,{"className":"flex items-center mb-6","children":["$","div",null,{"className":"inline-flex items-center px-3 py-1.5 bg-gray-50 text-gray-600 rounded-md text-sm font-normal","children":[["$","svg",null,{"className":"w-4 h-4 mr-2 text-gray-400","fill":"none","stroke":"currentColor","viewBox":"0 0 24 24","children":["$","path",null,{"strokeLinecap":"round","strokeLinejoin":"round","strokeWidth":2,"d":"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"}]}],["$","time",null,{"dateTime":"2024-03-04","children":"2024年03月04日"}]]}]}],["$","h1",null,{"className":"text-4xl font-bold text-gray-900 mb-6 text-center","children":"关于业务平台架构的思考"}],["$","div",null,{"className":"flex flex-wrap gap-2 mb-6 justify-center","children":[["$","$L13","业务架构",{"href":"/blog/tag/%E4%B8%9A%E5%8A%A1%E6%9E%B6%E6%9E%84/page/1/","className":"inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-200 text-gray-800 hover:bg-gray-300 hover:text-gray-900 transition-colors","children":"业务架构"}],["$","$L13","平台化",{"href":"/blog/tag/%E5%B9%B3%E5%8F%B0%E5%8C%96/page/1/","className":"inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-200 text-gray-800 hover:bg-gray-300 hover:text-gray-900 transition-colors","children":"平台化"}],["$","$L13","架构设计",{"href":"/blog/tag/%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/page/1/","className":"inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-200 text-gray-800 hover:bg-gray-300 hover:text-gray-900 transition-colors","children":"架构设计"}]]}]]}],["$","div",null,{"className":"max-w-5xl mx-auto","children":["$","$L14",null,{"content":"$15"}]}],["$","$10",null,{"fallback":["$","div",null,{"className":"mt-12 pt-8 border-t border-gray-200","children":"加载导航中..."}],"children":["$","$L16",null,{"globalNav":{"prev":{"slug":"engineering/domain/解析三户模型及建立账户模型","title":"解析三户模型及建立账户模型","description":"账户体系是支付系统的基础，它的设计直接影响整个系统的特性。这里探讨如何针对电子商务系统的账户体系设计。我们从一些基本概念开始入手，了解怎么建模。三户模型最早是在增强型电信运营图（Enhanced Telecom Operations Map，eTOM）中提出，在电信行业中得到广泛使用。","pubDate":"2024-03-03","tags":["业务架构","三户模型","账户体系"],"heroImage":"$undefined","content":"$17"},"next":{"slug":"engineering/domain/业务三重视角——业务模型","title":"业务三重视角——业务模型","description":"日常我们需要做一些事情来保证商业模式的正常运转，而关键业务就是商业模式中的一个重要模块。今天这篇文章将讨论业务模型，帮助你更好了解到企业的战略和战术，从而有助于制定指标体系、寻找业务机会以及提高工作价值。...","pubDate":"2024-03-05","tags":["业务架构","业务建模","领域分析"],"heroImage":"$undefined","content":"$18"}},"tagNav":{"业务架构":{"prev":"$5:props:children:props:children:props:children:2:props:children:props:globalNav:prev","next":"$5:props:children:props:children:props:children:2:props:children:props:globalNav:next"},"平台化":{"prev":null,"next":null},"架构设计":{"prev":null,"next":{"slug":"engineering/architecture/一个秒杀系统的设计思考","title":"一个秒杀系统的设计思考","description":"前言 秒杀大家都不陌生。自2011年首次出现以来，无论是双十一购物还是 12306抢票，秒杀场景已随处可见。简单来说，秒杀就是在同一时刻大量请求争抢购买同一商品并完成交易的过程。从架构视角来看，秒杀系统本质是一个高性能、高一致、高可用的三高系统。","pubDate":"2024-03-14","tags":["秒杀系统","高并发","架构设计"],"heroImage":"$undefined","content":"$19"}}}}]}],["$","$L1a",null,{}]]}]}]}]
8:null
c:[["$","meta","0",{"charSet":"utf-8"}],["$","meta","1",{"name":"viewport","content":"width=device-width, initial-scale=1"}]]
7:null
a:{"metadata":[["$","title","0",{"children":"关于业务平台架构的思考 - Skyfalling Blog"}],["$","meta","1",{"name":"description","content":"1. 职业上的事务，统称为「业务」——辞海 2. “业务”更白话一些来说，就是各行业中需要处理的事务，但通常偏向指销售的事务，因为任何公司单位最终仍然是以销售产品、销售服务、销售技术等等为主。“业务”最终的目的是“售出产品，换取利润”。——百度 3. anything that relates to..."}],["$","meta","2",{"property":"og:title","content":"关于业务平台架构的思考"}],["$","meta","3",{"property":"og:description","content":"1. 职业上的事务，统称为「业务」——辞海 2. “业务”更白话一些来说，就是各行业中需要处理的事务，但通常偏向指销售的事务，因为任何公司单位最终仍然是以销售产品、销售服务、销售技术等等为主。“业务”最终的目的是“售出产品，换取利润”。——百度 3. anything that relates to..."}],["$","meta","4",{"property":"og:type","content":"article"}],["$","meta","5",{"property":"article:published_time","content":"2024-03-04"}],["$","meta","6",{"property":"article:author","content":"Skyfalling"}],["$","meta","7",{"name":"twitter:card","content":"summary"}],["$","meta","8",{"name":"twitter:title","content":"关于业务平台架构的思考"}],["$","meta","9",{"name":"twitter:description","content":"1. 职业上的事务，统称为「业务」——辞海 2. “业务”更白话一些来说，就是各行业中需要处理的事务，但通常偏向指销售的事务，因为任何公司单位最终仍然是以销售产品、销售服务、销售技术等等为主。“业务”最终的目的是“售出产品，换取利润”。——百度 3. anything that relates to..."}],["$","link","10",{"rel":"shortcut icon","href":"/favicon.png"}],["$","link","11",{"rel":"icon","href":"/favicon.ico","type":"image/x-icon","sizes":"16x16"}],["$","link","12",{"rel":"icon","href":"/favicon.png"}],["$","link","13",{"rel":"apple-touch-icon","href":"/favicon.png"}]],"error":null,"digest":"$undefined"}
12:{"metadata":"$a:metadata","error":null,"digest":"$undefined"}
