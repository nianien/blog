<!DOCTYPE html><html lang="zh-CN"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/gitbook/_next/static/media/e4af272ccee01ff0-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="stylesheet" href="/gitbook/_next/static/css/443e11d9362f4e82.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/gitbook/_next/static/chunks/webpack-53d905a932a6f993.js"/><script src="/gitbook/_next/static/chunks/4bd1b696-a6a68ffbe959fe28.js" async=""></script><script src="/gitbook/_next/static/chunks/684-776aabfcbdbee233.js" async=""></script><script src="/gitbook/_next/static/chunks/main-app-75103b4b1f3159f6.js" async=""></script><script src="/gitbook/_next/static/chunks/874-80549eca86098588.js" async=""></script><script src="/gitbook/_next/static/chunks/app/layout-f035406da26395a3.js" async=""></script><script src="/gitbook/_next/static/chunks/app/blog/%5B...slug%5D/page-b420037c820534af.js" async=""></script><meta name="next-size-adjust" content=""/><title>Skyfalling</title><meta name="description" content="分享技术、生活和思考的个人博客"/><link rel="icon" href="/favicon.svg"/><script>document.querySelectorAll('body link[rel="icon"], body link[rel="apple-touch-icon"]').forEach(el => document.head.appendChild(el))</script><script src="/gitbook/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script></head><body class="__className_feb414"><div hidden=""><!--$--><!--/$--></div><div class="min-h-screen flex flex-col"><header class="bg-white shadow-sm"><nav class="mx-auto flex max-w-7xl items-center justify-between p-6 lg:px-8" aria-label="Global"><div class="flex lg:flex-1"><a class="-m-1.5 p-1.5" href="/gitbook/"><span class="sr-only">Skyfalling Blog</span><span class="text-2xl font-bold text-gray-900">Skyfalling</span></a></div><div class="flex lg:hidden"><button type="button" class="-m-2.5 inline-flex items-center justify-center rounded-md p-2.5 text-gray-700"><span class="sr-only">打开主菜单</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="h-6 w-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"></path></svg></button></div><div class="hidden lg:flex lg:gap-x-12"><a class="text-base font-semibold leading-6 transition-colors text-gray-900 hover:text-blue-600" href="/gitbook/">首页</a><a class="text-base font-semibold leading-6 transition-colors text-blue-600 border-b-2 border-blue-600 pb-1" href="/gitbook/blog/">博客</a><a class="text-base font-semibold leading-6 transition-colors text-gray-900 hover:text-blue-600" href="/gitbook/about/">关于</a></div><div class="hidden lg:flex lg:flex-1 lg:justify-end"><a class="text-base font-semibold leading-6 transition-colors text-gray-900 hover:text-blue-600" href="/gitbook/contact/">联系 <span aria-hidden="true">→</span></a></div></nav></header><main class="flex-1"><article class="py-24 sm:py-32"><div class="mx-auto max-w-3xl px-6 lg:px-8"><div class="xl:relative"><div class="mx-auto max-w-2xl"><div class="text-center"><time dateTime="2024-03-30" class="text-gray-500">2024年03月30日</time><h1 class="mt-6 text-3xl font-bold tracking-tight text-gray-900 sm:text-4xl">微服务拆分策略</h1><p class="mt-6 text-lg leading-8 text-gray-600">前面我们学习了微服务的全景架构，了解到相对于传统单体架构，微服务的优势，以及系统服务化的发展趋势。 对于新启动的项目，我们在权衡之后可以大方的使用微服务架构。但其实大部分情况下，我们还要去维护一些以前研发的单体系统，这些系统可能因为访问流量的膨胀、功能的扩张而显得非常臃肿不堪，急需要向微服务架构迁移...</p><div class="mt-6 flex justify-center gap-2"><a class="rounded-full bg-gray-100 px-3 py-1 text-sm font-medium text-gray-700 hover:bg-gray-200" href="/gitbook/blog/tag/%E5%BE%AE%E6%9C%8D%E5%8A%A1/page/1/">微服务</a></div></div><div class="mt-16 prose prose-lg prose-gray mx-auto"><div class="prose prose-lg prose-gray mx-auto">
<h1>微服务拆分策略</h1></p><p>前面我们学习了微服务的全景架构，了解到相对于传统单体架构，微服务的优势，以及系统服务化的发展趋势。</p><p>对于新启动的项目，我们在权衡之后可以大方的使用微服务架构。但其实大部分情况下，我们还要去维护一些以前研发的单体系统，这些系统可能因为访问流量的膨胀、功能的扩张而显得非常臃肿不堪，急需要向微服务架构迁移。</p><p><h3>1 微服务迁移准备  <a href="#scroller-1" id="scroller-1"></a></h3></p><p>1、需对业务充分了解，这是服务拆分，通信设计，资源整合的必要前提。</p><p>2、适应微服务架构设计原则：小版本，高速迭代。</p><p>3、快速的环境提供能力：依赖于云计算、容器技术，快速交付环境。</p><p>4、服务合理拆分：需符合团队结构或能逆向影响，能对组织架构进行微调并划分职责。（康威定律和逆康威定律）</p><p>5、基本的监控能力：包括基础的技术监控和业务监控。</p><p>6、快速的应用部署能力：需要部署管道提供快速的部署能力。</p><p>7、DevOps 自动化运维能力：需要具有良好的持续集成和持续交付能力，还需要对问题、故障的快速响应能力，开发、测试和运维能协同工作。</p><p><h3>2 微服务颗粒的拆分策略 <a href="#scroller-2" id="scroller-2"></a></h3></p><p>前面两篇文章我们学习了What & Why（什么是微服务和为什么需要做微服务架构），这一章我们就来探讨如何做微服务架构的拆分（How）。</p><p>微服务拆分没有一个绝对的标准答案，服务拆分的粒度需要根据业务场景来规划，而随着业务的发展，原先的架构方案也需要做调整。</p><p>虽然没有固定的套路，但是我们在业务实践过程中总结的一些经验，以做参考。</p><p><h4>2.1 基于业务逻辑拆分 <a href="#scroller-3" id="scroller-3"></a></h4></p><p>基于业务逻辑拆分相对好理解一点，典型的单一职责原则，我们将功能相近的业务整合到一个服务颗粒上。比如一个办公领域系统，考勤、工作流、音视频会议是是三个截然不同的业务领域，这可能就是我们拆分的一个入手点。</p><strong>2.1.1 领域模型拆分</strong></p><p>领域驱动设计DDD（Domain-Driven Design 领域驱动设计）是一个很简单的概念，表示我们对系统的划分是基于领域的，也即是基于业务方向去思考的。</p><p>举一个典型的电商业务例子。电商的业务体系庞大，涉及各方面的细节。但是我们大概能够根据业务的职能做一个拆分，比如阿里的电商中台业务，包含 用户账号子系统、商品子系统、订单子系统、客户子系统、物流子系统 等。</p><p>因为职能不同，这些领域之间包含清晰的界限，所以我们可以按照这个方向将服务于不同领域（商品域和订单域）的子系统拆成独立的服务颗粒。如下图：</p><img src="/images/books/image_47.png" alt="" /><p><strong>2.1.2 用户群体拆分</strong><p>根据用户群体做拆分，我们首先要了解自己的系统业务里的用户角色领域是否没有功能耦合，有清晰的领域界限。</p><p>比如教育信息化系统，教师的业务场景和学生的业务场景，基本比较独立，而且拆分后流量上有明显的削弱，这时候结合具体的业务分析，看是否有价值。如下图所示：</p><img src="/images/books/image_40.png" alt="" /><p><h4>2.2 基于可扩展拆分  <a href="#scroller-6" id="scroller-6"></a></h4><p>这个需要区分系统中变与不变的部分，不变的部分一般是成熟的、通用的服务功能，变的部分一般是改动比较多、满足业务迭代扩展性需要的功能，我们可以将不变的部分拆分出来，作为共用的服务，将变的部分独立出来满足个性化扩展需要。同时根据二八原则，系统中经常变动的部分大约只占 20%，而剩下的 80% 基本不变或极少变化，这样的拆分也解决了发布频率过多而影响成熟服务稳定性的问题。比如一个电商领域的系统，用户信息、基本商品信息、物流信息 等模块的管理能力和视图界面，一般是比较稳定的；而类似运营活动的功能和页面一般是经常变化的（520、618、双11），会有不同的活动策略和视图界面，需要经常迭代发布。如下图所示</p>
<img src="/images/books/image_24_1.png" alt="" /><h4>2.3 基于可靠性拆分 <a href="#scroller-7" id="scroller-7"></a></h4></p><strong>2.3.1 核心模块拆分</strong></p><p>我们团队在做MySQL数据库和Redis集群拆分的时候，总会把一些重要的模块独立放在一个集群上，不与其他模块混用，而这个独立的集群，服务机性能要是最好的。这样做的目的是，当重要度较低的模块发生故障时，不会影响重要度高的模块。</p><p>同要的道理，我们会将  账号信息、登录信息、服务中心等重要度最高的要害模块单独拆分在一个服务颗粒上（因为这类模块不可用之后，整个系统基本完全瘫痪），再做成服务集群，来保障它的高可用。 如下图所示：</p><img src="/images/books/image_49.png" alt="" /><p><strong>2.3.2 主次链路拆分</strong></p><p>在各个业务系统中，其实都会有主次业务链路。主业务链条，完成了业务系统中最核心的那部分工作。而次链路是保证其他基础功能的稳定运行。</p><p>以电商为例子：商品搜索->商品详情页->购物车模块->订单结算->支付业务，就是一条最简单的主链路。主链路是整个系统的核心主战场，最好的资源跟火力都要放在这里，保证不失守。</p><p>一个系统一般有多条核心链路和多条次链路，互相支持构成一个完整的系统。而我们将主次链路进行拆分，主要为了以下几个目标。</p><p><strong>异常容错</strong></p><p>为主链路建立层次化的降级策略（多级降级），以及合理的熔断策略，这部分我们将在Hystrix服务容错降级的文章中详细解释。</p><p><strong>计算资源分配</strong></p><p>主链路通常来讲都是高频场景，自然需要更多的计算资源，最主要的体现就是集群里分配的虚机数量多。比如电商场景中特惠专场抢购等。</p><p>但是无论是虚机的分配，还是kubernetes的动态扩缩容，应该都需要单独优待，如资源分配倾斜，独立治理等。</p><p><strong>服务隔离</strong><p>主链路是高频且核心的主业务模块，把主链路的服务与其他起辅助作用的业务服务隔离开来，避免次链路服务的异常情况影响到主链路服务。</p><img src="/images/books/image_19_1.png" alt="" /><p><h4>2.4 基于性能需求拆分 <a href="#scroller-10" id="scroller-10"></a></h4></p><p>根据性能需求来进行拆分。简单来说就是访问量特别大，访问频率特别高的业务，又要保证高效的响应能力，这些业务对性能的要求特别高。比如积分竞拍、低价秒杀、限量抢购。</p><p>我们要识别出某些超高并发量的业务，尽可能把这部分业务独立拆分出来。这么做的原因非常简单，一个保证满足高性能业务需求，另一个保证业务的独立性，不互相影响。</p><p>类似积分竞拍、超低价秒杀、限量抢购，对瞬间峰值和计算性能要求是非常高的。这部分的业务如果跟其他通用业务放在一块，一个是可能互相影响，比如某个链路阻塞，会导致雪崩沿调用链向上传递。</p><p>另外一个是如果多个业务耦合在一块，发布频率变高、服务扩缩容变难、维护复杂度变高。</p><img src="/images/books/image_27.png" alt="" /><p><h3>3 总结拆分原则 <a href="#scroller-11" id="scroller-11"></a></h3><p>* 先少后多（微服务数量）、先粗后细(粒度)</p>
<p>* 基于业务逻辑进行拆分（用户群体、业务领域等模型）</p>
<p>* 基于可靠性（核心模块独立化、主次链路隔离）</p>
<p>* 基于性能拆分（独立拆分高性能场景）</p>
<p>* 接口需保证幂等</p>
<p>* 接口数据定义严禁内嵌，透传</p>
<p>* 规范化工程结构，符合微服务风格</p>
<p>* 不止对计算服务记性拆分，服务层 -> 缓存层 -> 数据层 的逐步拆解，才能发挥最大功效。</p>
</div></div><div class="mt-16 flex items-center justify-between border-t border-gray-200 pt-8"><a class="relative z-10 rounded-md px-4 py-2 text-sm font-semibold leading-6 text-gray-900 hover:text-blue-600 hover:bg-gray-50" href="/gitbook/blog/">← 返回博客列表</a></div><div class="mt-8 grid grid-cols-1 gap-8 border-t border-gray-200 pt-8 lg:grid-cols-2"><div class="group"><div class="flex items-center gap-x-3"><div class="text-sm text-gray-500">上一篇</div></div><h3 class="mt-2 text-lg font-semibold leading-6 text-gray-900 group-hover:text-gray-600"><a href="/gitbook/blog/wei-fu-wu-ji-qi-yan-jin-shi/"><span class="absolute inset-0"></span>微服务及其演进史</a></h3><p class="mt-3 text-sm leading-6 text-gray-600 line-clamp-2">在很多项目的业务初期阶段，高速迭代上线是首要考虑的事情，对后期的容量预估、可扩展性和系统健壮性、高可用一般没有那么重视。但随着业务的发展，用户量、请求量的暴增， 发现原来的单体系统已经远远不满足需求了，特别是随着互联网整体的高速发展，对系统的要求越来越高。 但是物理服务器的CPU、内存、存储器、连接...</p></div><div class="group"><div class="flex items-center gap-x-3"><div class="text-sm text-gray-500">下一篇</div></div><h3 class="mt-2 text-lg font-semibold leading-6 text-gray-900 group-hover:text-gray-600"><a href="/gitbook/blog/wei-fu-wu-chai-fen-ce-lve-fu-jia-pian/"><span class="absolute inset-0"></span>微服务拆分策略（附加篇）</a></h3><p class="mt-3 text-sm leading-6 text-gray-600 line-clamp-2">关于服务拆分的切入点，我们先从MartinL.Abbott所著《架构即未来》中所介绍的AKF扩展立方体出发寻找一些灵感，然后给出本文中关于服务拆分的两大维度。 1. AKF扩展立方体 AKF扩展立方体（Scalability Cube）是一种可扩展模型，这个立方体有三个轴线，每个轴线描述扩展性的一...</p></div></div></div></div></div></article><!--$--><!--/$--></main><footer class="bg-gray-900"><div class="mx-auto max-w-7xl px-6 py-12 md:flex md:items-center md:justify-between lg:px-8"><div class="flex justify-center space-x-6 md:order-2"><a class="text-gray-400 hover:text-gray-300" href="/gitbook/about/">关于</a><a class="text-gray-400 hover:text-gray-300" href="/gitbook/blog/">博客</a><a class="text-gray-400 hover:text-gray-300" href="/gitbook/contact/">联系</a></div><div class="mt-8 md:order-1 md:mt-0"><p class="text-center text-xs leading-5 text-gray-400">© 2024 Skyfalling Blog. All rights reserved.</p></div></div></footer></div><script src="/gitbook/_next/static/chunks/webpack-53d905a932a6f993.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n2:I[5651,[\"874\",\"static/chunks/874-80549eca86098588.js\",\"177\",\"static/chunks/app/layout-f035406da26395a3.js\"],\"default\"]\n3:I[7555,[],\"\"]\n4:I[1295,[],\"\"]\n5:I[6874,[\"874\",\"static/chunks/874-80549eca86098588.js\",\"909\",\"static/chunks/app/blog/%5B...slug%5D/page-b420037c820534af.js\"],\"\"]\n7:I[9665,[],\"OutletBoundary\"]\na:I[4911,[],\"AsyncMetadataOutlet\"]\nc:I[9665,[],\"ViewportBoundary\"]\ne:I[9665,[],\"MetadataBoundary\"]\n10:I[6614,[],\"\"]\n:HL[\"/gitbook/_next/static/media/e4af272ccee01ff0-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n:HL[\"/gitbook/_next/static/css/443e11d9362f4e82.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"vtR8vRym_dmCF4uoCEze4\",\"p\":\"/gitbook\",\"c\":[\"\",\"blog\",\"wei-fu-wu-chai-fen-ce-lve\",\"\"],\"i\":false,\"f\":[[[\"\",{\"children\":[\"blog\",{\"children\":[[\"slug\",\"wei-fu-wu-chai-fen-ce-lve\",\"c\"],{\"children\":[\"__PAGE__\",{}]}]}]},\"$undefined\",\"$undefined\",true],[\"\",[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/gitbook/_next/static/css/443e11d9362f4e82.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"zh-CN\",\"children\":[\"$\",\"body\",null,{\"className\":\"__className_feb414\",\"children\":[\"$\",\"div\",null,{\"className\":\"min-h-screen flex flex-col\",\"children\":[[\"$\",\"$L2\",null,{}],[\"$\",\"main\",null,{\"className\":\"flex-1\",\"children\":[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":404}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],[]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}],[\"$\",\"footer\",null,{\"className\":\"bg-gray-900\",\"children\":[\"$\",\"div\",null,{\"className\":\"mx-auto max-w-7xl px-6 py-12 md:flex md:items-center md:justify-between lg:px-8\",\"children\":[[\"$\",\"div\",null,{\"className\":\"flex justify-center space-x-6 md:order-2\",\"children\":[[\"$\",\"$L5\",null,{\"href\":\"/about\",\"className\":\"text-gray-400 hover:text-gray-300\",\"children\":\"关于\"}],[\"$\",\"$L5\",null,{\"href\":\"/blog\",\"className\":\"text-gray-400 hover:text-gray-300\",\"children\":\"博客\"}],[\"$\",\"$L5\",null,{\"href\":\"/contact\",\"className\":\"text-gray-400 hover:text-gray-300\",\"children\":\"联系\"}]]}],[\"$\",\"div\",null,{\"className\":\"mt-8 md:order-1 md:mt-0\",\"children\":[\"$\",\"p\",null,{\"className\":\"text-center text-xs leading-5 text-gray-400\",\"children\":\"© 2024 Skyfalling Blog. All rights reserved.\"}]}]]}]}]]}]}]}]]}],{\"children\":[\"blog\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[[\"slug\",\"wei-fu-wu-chai-fen-ce-lve\",\"c\"],[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"__PAGE__\",[\"$\",\"$1\",\"c\",{\"children\":[\"$L6\",null,[\"$\",\"$L7\",null,{\"children\":[\"$L8\",\"$L9\",[\"$\",\"$La\",null,{\"promise\":\"$@b\"}]]}]]}],{},null,false]},null,false]},null,false]},null,false],[\"$\",\"$1\",\"h\",{\"children\":[null,[\"$\",\"$1\",\"PbChokqnqngpCyYxlsas3v\",{\"children\":[[\"$\",\"$Lc\",null,{\"children\":\"$Ld\"}],[\"$\",\"meta\",null,{\"name\":\"next-size-adjust\",\"content\":\"\"}]]}],[\"$\",\"$Le\",null,{\"children\":\"$Lf\"}]]}],false]],\"m\":\"$undefined\",\"G\":[\"$10\",\"$undefined\"],\"s\":false,\"S\":true}\n"])</script><script>self.__next_f.push([1,"11:\"$Sreact.suspense\"\n12:I[4911,[],\"AsyncMetadata\"]\nf:[\"$\",\"div\",null,{\"hidden\":true,\"children\":[\"$\",\"$11\",null,{\"fallback\":null,\"children\":[\"$\",\"$L12\",null,{\"promise\":\"$@13\"}]}]}]\n14:T2194,"])</script><script>self.__next_f.push([1,"\n\u003ch1\u003e微服务拆分策略\u003c/h1\u003e\u003c/p\u003e\u003cp\u003e前面我们学习了微服务的全景架构，了解到相对于传统单体架构，微服务的优势，以及系统服务化的发展趋势。\u003c/p\u003e\u003cp\u003e对于新启动的项目，我们在权衡之后可以大方的使用微服务架构。但其实大部分情况下，我们还要去维护一些以前研发的单体系统，这些系统可能因为访问流量的膨胀、功能的扩张而显得非常臃肿不堪，急需要向微服务架构迁移。\u003c/p\u003e\u003cp\u003e\u003ch3\u003e1 微服务迁移准备  \u003ca href=\"#scroller-1\" id=\"scroller-1\"\u003e\u003c/a\u003e\u003c/h3\u003e\u003c/p\u003e\u003cp\u003e1、需对业务充分了解，这是服务拆分，通信设计，资源整合的必要前提。\u003c/p\u003e\u003cp\u003e2、适应微服务架构设计原则：小版本，高速迭代。\u003c/p\u003e\u003cp\u003e3、快速的环境提供能力：依赖于云计算、容器技术，快速交付环境。\u003c/p\u003e\u003cp\u003e4、服务合理拆分：需符合团队结构或能逆向影响，能对组织架构进行微调并划分职责。（康威定律和逆康威定律）\u003c/p\u003e\u003cp\u003e5、基本的监控能力：包括基础的技术监控和业务监控。\u003c/p\u003e\u003cp\u003e6、快速的应用部署能力：需要部署管道提供快速的部署能力。\u003c/p\u003e\u003cp\u003e7、DevOps 自动化运维能力：需要具有良好的持续集成和持续交付能力，还需要对问题、故障的快速响应能力，开发、测试和运维能协同工作。\u003c/p\u003e\u003cp\u003e\u003ch3\u003e2 微服务颗粒的拆分策略 \u003ca href=\"#scroller-2\" id=\"scroller-2\"\u003e\u003c/a\u003e\u003c/h3\u003e\u003c/p\u003e\u003cp\u003e前面两篇文章我们学习了What \u0026 Why（什么是微服务和为什么需要做微服务架构），这一章我们就来探讨如何做微服务架构的拆分（How）。\u003c/p\u003e\u003cp\u003e微服务拆分没有一个绝对的标准答案，服务拆分的粒度需要根据业务场景来规划，而随着业务的发展，原先的架构方案也需要做调整。\u003c/p\u003e\u003cp\u003e虽然没有固定的套路，但是我们在业务实践过程中总结的一些经验，以做参考。\u003c/p\u003e\u003cp\u003e\u003ch4\u003e2.1 基于业务逻辑拆分 \u003ca href=\"#scroller-3\" id=\"scroller-3\"\u003e\u003c/a\u003e\u003c/h4\u003e\u003c/p\u003e\u003cp\u003e基于业务逻辑拆分相对好理解一点，典型的单一职责原则，我们将功能相近的业务整合到一个服务颗粒上。比如一个办公领域系统，考勤、工作流、音视频会议是是三个截然不同的业务领域，这可能就是我们拆分的一个入手点。\u003c/p\u003e\u003cstrong\u003e2.1.1 领域模型拆分\u003c/strong\u003e\u003c/p\u003e\u003cp\u003e领域驱动设计DDD（Domain-Driven Design 领域驱动设计）是一个很简单的概念，表示我们对系统的划分是基于领域的，也即是基于业务方向去思考的。\u003c/p\u003e\u003cp\u003e举一个典型的电商业务例子。电商的业务体系庞大，涉及各方面的细节。但是我们大概能够根据业务的职能做一个拆分，比如阿里的电商中台业务，包含 用户账号子系统、商品子系统、订单子系统、客户子系统、物流子系统 等。\u003c/p\u003e\u003cp\u003e因为职能不同，这些领域之间包含清晰的界限，所以我们可以按照这个方向将服务于不同领域（商品域和订单域）的子系统拆成独立的服务颗粒。如下图：\u003c/p\u003e\u003cimg src=\"/images/books/image_47.png\" alt=\"\" /\u003e\u003cp\u003e\u003cstrong\u003e2.1.2 用户群体拆分\u003c/strong\u003e\u003cp\u003e根据用户群体做拆分，我们首先要了解自己的系统业务里的用户角色领域是否没有功能耦合，有清晰的领域界限。\u003c/p\u003e\u003cp\u003e比如教育信息化系统，教师的业务场景和学生的业务场景，基本比较独立，而且拆分后流量上有明显的削弱，这时候结合具体的业务分析，看是否有价值。如下图所示：\u003c/p\u003e\u003cimg src=\"/images/books/image_40.png\" alt=\"\" /\u003e\u003cp\u003e\u003ch4\u003e2.2 基于可扩展拆分  \u003ca href=\"#scroller-6\" id=\"scroller-6\"\u003e\u003c/a\u003e\u003c/h4\u003e\u003cp\u003e这个需要区分系统中变与不变的部分，不变的部分一般是成熟的、通用的服务功能，变的部分一般是改动比较多、满足业务迭代扩展性需要的功能，我们可以将不变的部分拆分出来，作为共用的服务，将变的部分独立出来满足个性化扩展需要。同时根据二八原则，系统中经常变动的部分大约只占 20%，而剩下的 80% 基本不变或极少变化，这样的拆分也解决了发布频率过多而影响成熟服务稳定性的问题。比如一个电商领域的系统，用户信息、基本商品信息、物流信息 等模块的管理能力和视图界面，一般是比较稳定的；而类似运营活动的功能和页面一般是经常变化的（520、618、双11），会有不同的活动策略和视图界面，需要经常迭代发布。如下图所示\u003c/p\u003e\n\u003cimg src=\"/images/books/image_24_1.png\" alt=\"\" /\u003e\u003ch4\u003e2.3 基于可靠性拆分 \u003ca href=\"#scroller-7\" id=\"scroller-7\"\u003e\u003c/a\u003e\u003c/h4\u003e\u003c/p\u003e\u003cstrong\u003e2.3.1 核心模块拆分\u003c/strong\u003e\u003c/p\u003e\u003cp\u003e我们团队在做MySQL数据库和Redis集群拆分的时候，总会把一些重要的模块独立放在一个集群上，不与其他模块混用，而这个独立的集群，服务机性能要是最好的。这样做的目的是，当重要度较低的模块发生故障时，不会影响重要度高的模块。\u003c/p\u003e\u003cp\u003e同要的道理，我们会将  账号信息、登录信息、服务中心等重要度最高的要害模块单独拆分在一个服务颗粒上（因为这类模块不可用之后，整个系统基本完全瘫痪），再做成服务集群，来保障它的高可用。 如下图所示：\u003c/p\u003e\u003cimg src=\"/images/books/image_49.png\" alt=\"\" /\u003e\u003cp\u003e\u003cstrong\u003e2.3.2 主次链路拆分\u003c/strong\u003e\u003c/p\u003e\u003cp\u003e在各个业务系统中，其实都会有主次业务链路。主业务链条，完成了业务系统中最核心的那部分工作。而次链路是保证其他基础功能的稳定运行。\u003c/p\u003e\u003cp\u003e以电商为例子：商品搜索-\u003e商品详情页-\u003e购物车模块-\u003e订单结算-\u003e支付业务，就是一条最简单的主链路。主链路是整个系统的核心主战场，最好的资源跟火力都要放在这里，保证不失守。\u003c/p\u003e\u003cp\u003e一个系统一般有多条核心链路和多条次链路，互相支持构成一个完整的系统。而我们将主次链路进行拆分，主要为了以下几个目标。\u003c/p\u003e\u003cp\u003e\u003cstrong\u003e异常容错\u003c/strong\u003e\u003c/p\u003e\u003cp\u003e为主链路建立层次化的降级策略（多级降级），以及合理的熔断策略，这部分我们将在Hystrix服务容错降级的文章中详细解释。\u003c/p\u003e\u003cp\u003e\u003cstrong\u003e计算资源分配\u003c/strong\u003e\u003c/p\u003e\u003cp\u003e主链路通常来讲都是高频场景，自然需要更多的计算资源，最主要的体现就是集群里分配的虚机数量多。比如电商场景中特惠专场抢购等。\u003c/p\u003e\u003cp\u003e但是无论是虚机的分配，还是kubernetes的动态扩缩容，应该都需要单独优待，如资源分配倾斜，独立治理等。\u003c/p\u003e\u003cp\u003e\u003cstrong\u003e服务隔离\u003c/strong\u003e\u003cp\u003e主链路是高频且核心的主业务模块，把主链路的服务与其他起辅助作用的业务服务隔离开来，避免次链路服务的异常情况影响到主链路服务。\u003c/p\u003e\u003cimg src=\"/images/books/image_19_1.png\" alt=\"\" /\u003e\u003cp\u003e\u003ch4\u003e2.4 基于性能需求拆分 \u003ca href=\"#scroller-10\" id=\"scroller-10\"\u003e\u003c/a\u003e\u003c/h4\u003e\u003c/p\u003e\u003cp\u003e根据性能需求来进行拆分。简单来说就是访问量特别大，访问频率特别高的业务，又要保证高效的响应能力，这些业务对性能的要求特别高。比如积分竞拍、低价秒杀、限量抢购。\u003c/p\u003e\u003cp\u003e我们要识别出某些超高并发量的业务，尽可能把这部分业务独立拆分出来。这么做的原因非常简单，一个保证满足高性能业务需求，另一个保证业务的独立性，不互相影响。\u003c/p\u003e\u003cp\u003e类似积分竞拍、超低价秒杀、限量抢购，对瞬间峰值和计算性能要求是非常高的。这部分的业务如果跟其他通用业务放在一块，一个是可能互相影响，比如某个链路阻塞，会导致雪崩沿调用链向上传递。\u003c/p\u003e\u003cp\u003e另外一个是如果多个业务耦合在一块，发布频率变高、服务扩缩容变难、维护复杂度变高。\u003c/p\u003e\u003cimg src=\"/images/books/image_27.png\" alt=\"\" /\u003e\u003cp\u003e\u003ch3\u003e3 总结拆分原则 \u003ca href=\"#scroller-11\" id=\"scroller-11\"\u003e\u003c/a\u003e\u003c/h3\u003e\u003cp\u003e* 先少后多（微服务数量）、先粗后细(粒度)\u003c/p\u003e\n\u003cp\u003e* 基于业务逻辑进行拆分（用户群体、业务领域等模型）\u003c/p\u003e\n\u003cp\u003e* 基于可靠性（核心模块独立化、主次链路隔离）\u003c/p\u003e\n\u003cp\u003e* 基于性能拆分（独立拆分高性能场景）\u003c/p\u003e\n\u003cp\u003e* 接口需保证幂等\u003c/p\u003e\n\u003cp\u003e* 接口数据定义严禁内嵌，透传\u003c/p\u003e\n\u003cp\u003e* 规范化工程结构，符合微服务风格\u003c/p\u003e\n\u003cp\u003e* 不止对计算服务记性拆分，服务层 -\u003e 缓存层 -\u003e 数据层 的逐步拆解，才能发挥最大功效。\u003c/p\u003e\n"])</script><script>self.__next_f.push([1,"6:[\"$\",\"article\",null,{\"className\":\"py-24 sm:py-32\",\"children\":[\"$\",\"div\",null,{\"className\":\"mx-auto max-w-3xl px-6 lg:px-8\",\"children\":[\"$\",\"div\",null,{\"className\":\"xl:relative\",\"children\":[\"$\",\"div\",null,{\"className\":\"mx-auto max-w-2xl\",\"children\":[[\"$\",\"div\",null,{\"className\":\"text-center\",\"children\":[[\"$\",\"time\",null,{\"dateTime\":\"2024-03-30\",\"className\":\"text-gray-500\",\"children\":\"2024年03月30日\"}],[\"$\",\"h1\",null,{\"className\":\"mt-6 text-3xl font-bold tracking-tight text-gray-900 sm:text-4xl\",\"children\":\"微服务拆分策略\"}],[\"$\",\"p\",null,{\"className\":\"mt-6 text-lg leading-8 text-gray-600\",\"children\":\"前面我们学习了微服务的全景架构，了解到相对于传统单体架构，微服务的优势，以及系统服务化的发展趋势。 对于新启动的项目，我们在权衡之后可以大方的使用微服务架构。但其实大部分情况下，我们还要去维护一些以前研发的单体系统，这些系统可能因为访问流量的膨胀、功能的扩张而显得非常臃肿不堪，急需要向微服务架构迁移...\"}],[\"$\",\"div\",null,{\"className\":\"mt-6 flex justify-center gap-2\",\"children\":[[\"$\",\"$L5\",\"微服务\",{\"href\":\"/blog/tag/%E5%BE%AE%E6%9C%8D%E5%8A%A1/page/1\",\"className\":\"rounded-full bg-gray-100 px-3 py-1 text-sm font-medium text-gray-700 hover:bg-gray-200\",\"children\":\"微服务\"}]]}]]}],[\"$\",\"div\",null,{\"className\":\"mt-16 prose prose-lg prose-gray mx-auto\",\"children\":[\"$\",\"div\",null,{\"className\":\"prose prose-lg prose-gray mx-auto\",\"dangerouslySetInnerHTML\":{\"__html\":\"$14\"}}]}],[\"$\",\"div\",null,{\"className\":\"mt-16 flex items-center justify-between border-t border-gray-200 pt-8\",\"children\":[\"$\",\"$L5\",null,{\"href\":\"/blog\",\"className\":\"relative z-10 rounded-md px-4 py-2 text-sm font-semibold leading-6 text-gray-900 hover:text-blue-600 hover:bg-gray-50\",\"children\":\"← 返回博客列表\"}]}],[\"$\",\"div\",null,{\"className\":\"mt-8 grid grid-cols-1 gap-8 border-t border-gray-200 pt-8 lg:grid-cols-2\",\"children\":[[\"$\",\"div\",null,{\"className\":\"group\",\"children\":[[\"$\",\"div\",null,{\"className\":\"flex items-center gap-x-3\",\"children\":[\"$\",\"div\",null,{\"className\":\"text-sm text-gray-500\",\"children\":\"上一篇\"}]}],[\"$\",\"h3\",null,{\"className\":\"mt-2 text-lg font-semibold leading-6 text-gray-900 group-hover:text-gray-600\",\"children\":[\"$\",\"$L5\",null,{\"href\":\"/blog/wei-fu-wu-ji-qi-yan-jin-shi\",\"children\":[[\"$\",\"span\",null,{\"className\":\"absolute inset-0\"}],\"微服务及其演进史\"]}]}],[\"$\",\"p\",null,{\"className\":\"mt-3 text-sm leading-6 text-gray-600 line-clamp-2\",\"children\":\"在很多项目的业务初期阶段，高速迭代上线是首要考虑的事情，对后期的容量预估、可扩展性和系统健壮性、高可用一般没有那么重视。但随着业务的发展，用户量、请求量的暴增， 发现原来的单体系统已经远远不满足需求了，特别是随着互联网整体的高速发展，对系统的要求越来越高。 但是物理服务器的CPU、内存、存储器、连接...\"}]]}],[\"$\",\"div\",null,{\"className\":\"group\",\"children\":[[\"$\",\"div\",null,{\"className\":\"flex items-center gap-x-3\",\"children\":[\"$\",\"div\",null,{\"className\":\"text-sm text-gray-500\",\"children\":\"下一篇\"}]}],[\"$\",\"h3\",null,{\"className\":\"mt-2 text-lg font-semibold leading-6 text-gray-900 group-hover:text-gray-600\",\"children\":[\"$\",\"$L5\",null,{\"href\":\"/blog/wei-fu-wu-chai-fen-ce-lve-fu-jia-pian\",\"children\":[[\"$\",\"span\",null,{\"className\":\"absolute inset-0\"}],\"微服务拆分策略（附加篇）\"]}]}],[\"$\",\"p\",null,{\"className\":\"mt-3 text-sm leading-6 text-gray-600 line-clamp-2\",\"children\":\"关于服务拆分的切入点，我们先从MartinL.Abbott所著《架构即未来》中所介绍的AKF扩展立方体出发寻找一些灵感，然后给出本文中关于服务拆分的两大维度。 1. AKF扩展立方体 AKF扩展立方体（Scalability Cube）是一种可扩展模型，这个立方体有三个轴线，每个轴线描述扩展性的一...\"}]]}]]}]]}]}]}]}]\n"])</script><script>self.__next_f.push([1,"9:null\n"])</script><script>self.__next_f.push([1,"d:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"meta\",\"1\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\n8:null\n"])</script><script>self.__next_f.push([1,"b:{\"metadata\":[[\"$\",\"title\",\"0\",{\"children\":\"Skyfalling\"}],[\"$\",\"meta\",\"1\",{\"name\":\"description\",\"content\":\"分享技术、生活和思考的个人博客\"}],[\"$\",\"link\",\"2\",{\"rel\":\"icon\",\"href\":\"/favicon.svg\"}]],\"error\":null,\"digest\":\"$undefined\"}\n13:{\"metadata\":\"$b:metadata\",\"error\":null,\"digest\":\"$undefined\"}\n"])</script></body></html>